<!DOCTYPE html>
<html lang="es">
<head>
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal LAP.IA - Gesti√≥n Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { lapiOrange: '#F26522', lapiLight: '#FFF5F0', lapiDark: '#D9531E' } } } }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        @keyframes sweep { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .animate-sweep { animation: sweep 2s infinite linear; }

        @keyframes fillBar { from { width: 0%; } }
        .animate-fill-bar { animation: fillBar 1.2s ease-out forwards; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-storage-compat.js"></script>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex overflow-hidden">

<div id="indicador-carga" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-5 py-2 rounded-full shadow-2xl z-[120] flex items-center space-x-3 text-sm font-bold fade-in border border-gray-700">
 <div class="animate-spin h-4 w-4 border-2 border-lapiOrange border-t-transparent rounded-full"></div>
  <span id="texto-indicador-carga">Sincronizando...</span>
 </div>

    <div id="toast-container" class="fixed top-5 right-5 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <div id="modal-notas" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center fade-in">     <div class="bg-white rounded-lg shadow-2xl w-full max-w-md mx-4 flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h3 class="font-bold text-gray-800" id="modal-titulo">Comentarios del Documento</h3>
                <button onclick="cerrarModal('modal-notas')" class="text-gray-500 hover:text-red-500 transition font-bold text-xl">&times;</button>
            </div>
            <div id="modal-chat" class="p-4 flex-1 overflow-y-auto space-y-3 chat-scroll bg-gray-50"></div>
            <div class="p-4 border-t border-gray-200 bg-white rounded-b-lg flex space-x-2">
                <input type="text" id="input-nota" class="flex-1 border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-lapiOrange outline-none" placeholder="Escribe una observaci√≥n...">
                <button onclick="agregarNota()" class="bg-lapiOrange hover:bg-lapiDark text-white px-4 py-2 rounded text-sm font-bold transition">Enviar</button>
            </div>
        </div>
    </div>

    <div id="modal-checklist" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[110] flex items-center justify-center fade-in p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-6xl flex flex-col max-h-[95vh] h-full overflow-hidden border-t-4 border-lapiOrange">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                <div>
                    <h3 class="font-bold text-gray-800 text-lg">Auditor√≠a Documental LAP.IA</h3>
                    <p id="checklist-subtitulo" class="text-xs text-gray-500">Documento</p>
                </div>
                <button onclick="cerrarModal('modal-checklist')" class="text-gray-500 hover:text-red-500 transition font-bold text-xl">&times;</button>
            </div>
            
            <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
                <div class="w-full lg:w-3/5 bg-gray-300 p-2 flex flex-col border-r border-gray-200">
                    <iframe id="visor-pdf-iframe" class="w-full h-full rounded shadow-inner bg-white" src=""></iframe>
                </div>
                
                <div class="w-full lg:w-2/5 p-5 overflow-y-auto bg-white flex flex-col">
                    <h4 class="text-sm font-bold text-gray-600 mb-3 border-b pb-1">Criterios Evaluados:</h4>
                    <ul id="lista-checklist" class="space-y-3 flex-1"></ul>
                    
                    <div class="pt-4 mt-4 border-t border-gray-100 text-center">
                        <button onclick="cerrarModal('modal-checklist')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded text-sm font-bold transition">Cerrar Visor</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="pantalla-login" class="absolute inset-0 bg-lapiLight flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-96 border-t-4 border-lapiOrange">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">Portal <span class="text-lapiOrange">LAP.IA</span></h1>
                <p class="text-xs text-gray-500 mt-1">Gesti√≥n Documental Inteligente</p>
            </div>
            <label class="block text-sm font-medium text-gray-600 mb-2">Selecciona tu acceso:</label>
            <select id="selector-acceso" class="w-full p-2 border border-gray-300 rounded mb-4 focus:ring-2 focus:ring-lapiOrange bg-white">
                <option value="admin" class="font-bold">üëë Administrador General</option>
            </select>
            <button onclick="iniciarSesion()" class="w-full bg-lapiOrange hover:bg-lapiDark text-white font-bold py-2 rounded transition shadow-md">Ingresar a la plataforma</button>
        </div>
    </div>

    <aside id="sidebar" class="hidden w-64 bg-gray-900 text-white flex-col shadow-lg z-40">
        <div class="p-5 border-b border-gray-800">
            <h2 class="text-2xl font-extrabold tracking-tight cursor-pointer" onclick="mostrarVista('vista-inicio', document.getElementById('btn-nav-inicio'))">LAP<span class="text-lapiOrange">.IA</span></h2>
            <p id="usuario-actual" class="text-xs text-gray-400 mt-1">Usuario</p>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="mostrarVista('vista-inicio', this)" id="btn-nav-inicio" class="w-full text-left p-3 rounded hover:bg-gray-800 transition font-medium flex items-center bg-gray-800 border-l-4 border-lapiOrange">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg> Inicio
            </button>
            
            <button onclick="mostrarVista('vista-admin', this)" id="btn-nav-admin" class="w-full text-left p-3 rounded hover:bg-gray-800 transition hidden font-medium">Panel de Red</button>
            <button onclick="mostrarVista('vista-admin-directorio', this)" id="btn-nav-directorio" class="w-full text-left p-3 rounded hover:bg-gray-800 transition hidden font-medium flex justify-between items-center">Directorio ‚ûî</button>
            <button onclick="mostrarVista('vista-minas', this)" id="btn-nav-minas" class="w-full text-left p-3 rounded hover:bg-gray-800 transition hidden font-medium text-yellow-500">M√≥dulo MINAS ‚õèÔ∏è</button>
            
            <button onclick="mostrarVista('vista-registro', this)" id="btn-nav-registro" class="w-full text-left p-3 rounded hover:bg-gray-800 transition hidden font-medium">Registro de Pacientes</button>
            <button onclick="mostrarVista('vista-carga', this)" id="btn-nav-carga" class="w-full text-left p-3 rounded hover:bg-gray-800 transition hidden font-medium">M√≥dulo Documental</button>
            
            <div class="pt-4 mt-2 border-t border-gray-800">
                <p class="text-[10px] text-gray-500 uppercase tracking-wider mb-2 font-bold px-2">Herramientas IA</p>
                <button onclick="mostrarVista('vista-analisis-libre', this)" id="btn-nav-libre" class="w-full text-left p-3 rounded hover:bg-gray-800 transition font-medium flex items-center">
                    <svg class="w-4 h-4 mr-2 text-lapiOrange" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    Laboratorio LAP.IA
                </button>
            </div>
        </nav>
        <div class="p-4 border-t border-gray-800"><button onclick="cerrarSesion()" class="text-sm text-red-400 hover:text-red-300 w-full text-left">Salir del Sistema</button></div>
    </aside>

    <main id="contenido-principal" class="hidden flex-1 flex flex-col overflow-y-auto bg-gray-50">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 sticky top-0">
            <h2 id="titulo-vista" class="text-xl font-bold text-gray-700">Cargando...</h2>
            <div class="flex items-center space-x-3 bg-gray-100 p-2 rounded-lg border border-gray-200">
                <label class="text-sm font-bold text-gray-500">D√≠a operativo:</label>
                <input type="date" id="fecha-global" onchange="cambiarFecha()" class="border-none bg-transparent rounded p-1 text-sm font-bold focus:ring-0 text-lapiOrange outline-none cursor-pointer">
            </div>
        </header>

        <div class="p-6 h-full relative">
            
            <section id="vista-inicio" class="hidden flex-col items-center justify-center min-h-[80%] fade-in">
                <div class="text-center mb-10">
                    <h2 class="text-4xl font-extrabold text-gray-800 mb-2">Bienvenido a <span class="text-lapiOrange">LAP.IA</span></h2>
                    <p class="text-gray-500">Selecciona el m√≥dulo con el que deseas trabajar hoy.</p>
                </div>
                <div id="grid-inicio" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-5xl">
                    </div>
            </section>

            <section id="vista-admin" class="hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-500"><p class="text-sm text-gray-500 font-medium">Estudios Totales (Red)</p><p id="admin-totales" class="text-3xl font-bold text-gray-800">0</p></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-lapiOrange"><p class="text-sm text-gray-500 font-medium">Progreso Global Carga</p><p id="admin-carga" class="text-3xl font-bold text-gray-800">0%</p></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500"><p class="text-sm text-gray-500 font-medium">Aprobaci√≥n LAP.IA Global</p><p id="admin-ia" class="text-3xl font-bold text-gray-800">0%</p></div>
                </div>
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center"><h3 class="font-bold text-gray-700">Estado Operativo por Sucursal</h3></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead><tr class="bg-white text-gray-500 border-b"><th class="p-4 font-medium">Sucursal</th><th class="p-4 font-medium text-center">Estudios</th><th class="p-4 font-medium">Carga F√≠sica</th><th class="p-4 font-medium">Aprobaci√≥n LAP.IA</th><th class="p-4 font-medium text-center">Acci√≥n</th></tr></thead>
                            <tbody id="tabla-admin-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="vista-admin-directorio" class="hidden flex flex-col h-full">
                <div class="bg-white p-6 rounded-lg shadow-sm flex-1 border-t-4 border-lapiOrange">
                    <h3 class="font-bold text-gray-700 text-lg mb-2">Directorio de Sucursales LAPI</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="grid-directorio"></div>
                </div>
            </section>

            <section id="vista-admin-detalle" class="hidden flex flex-col h-full space-y-4">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-600 gap-4">
                    <div><h3 class="font-bold text-gray-800 text-xl" id="detalle-titulo">Sucursal</h3><p class="text-sm text-gray-500">Auditor√≠a LAP.IA</p></div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="simularDescarga('revisados')" class="bg-green-100 hover:bg-green-200 text-green-700 border border-green-300 text-xs font-bold py-2 px-4 rounded transition flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> Descargar Revisados IA</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-blue-400"><p class="text-xs text-gray-500 font-medium">Estudios Registrados</p><p id="audit-estudios" class="text-2xl font-bold text-gray-800">0</p></div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-lapiOrange"><p class="text-xs text-gray-500 font-medium">Progreso de Carga</p><p id="audit-carga" class="text-2xl font-bold text-gray-800">0%</p></div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-green-400"><p class="text-xs text-gray-500 font-medium">Aprobaci√≥n LAP.IA</p><p id="audit-ia" class="text-2xl font-bold text-gray-800">0%</p></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm flex-1 flex flex-col border-t border-gray-100">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100 flex-wrap gap-2">
                        <h3 class="font-bold text-gray-700">Archivos del D√≠a</h3>
                        <div class="flex space-x-2 w-full md:w-auto">
                            <div class="bg-gray-50 flex items-center px-3 rounded border border-gray-300">
                                <span>üîç</span><input type="text" id="buscadorRed" onkeyup="generarVistaDetalleAdmin()" class="p-1 bg-transparent outline-none text-sm w-full" placeholder="Buscar nombre o folio...">
                            </div>
                            <select id="filtro-admin" onchange="generarVistaDetalleAdmin()" class="border border-gray-300 text-sm rounded p-1 text-gray-600 focus:ring-lapiOrange outline-none"><option value="registro">Ordenar por: Registro</option><option value="paciente">Ordenar por: Paciente</option><option value="estudio">Ordenar por: Tipo de Estudio</option></select>
                        </div>
                    </div>
                    <div id="contenedorDetalleAdmin" class="flex-1 overflow-y-auto space-y-3 pr-2"></div>
                </div>
            </section>

            <section id="vista-minas" class="hidden h-full flex flex-col lg:flex-row gap-6">
                <div class="bg-white p-6 rounded-lg shadow-sm w-full lg:w-1/3 border-t-4 border-yellow-500 flex flex-col h-full">
                <div id="drop-zone-minas" 
                         ondragenter="event.preventDefault(); event.stopPropagation();"
                         ondragover="event.preventDefault(); event.stopPropagation(); this.classList.add('bg-yellow-200', 'border-yellow-600');" 
                         ondragleave="event.preventDefault(); event.stopPropagation(); this.classList.remove('bg-yellow-200', 'border-yellow-600');" 
                         ondrop="event.preventDefault(); event.stopPropagation(); this.classList.remove('bg-yellow-200', 'border-yellow-600'); procesarLoteArchivosMinas(event.dataTransfer.files);"
                         class="border-2 border-dashed border-yellow-400 rounded-lg p-6 text-center bg-yellow-50 hover:bg-yellow-100 transition cursor-pointer mb-6"
                         onclick="document.getElementById('file-upload-lote').click()">
                        
                        <div class="pointer-events-none">
                            <p class="text-sm text-yellow-800 font-bold">üì• Arrastra aqu√≠ tus PDFs (M√°x. 5 a la vez)</p>
                            <p class="text-[10px] text-yellow-600 mt-1">Da clic o arrastra. La IA leer√° los datos y armar√° los expedientes.</p>
                        </div>
                        
                        <input type="file" id="file-upload-lote" multiple accept="application/pdf" class="hidden" onchange="procesarLoteArchivosMinas(this.files)">
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-xl mb-1 flex items-center"><span class="mr-2 text-2xl">‚õèÔ∏è</span> Registro MINAS</h3>
                        <p class="text-xs text-gray-500 mb-6">Alta de pacientes e identificadores.</p>
                    </div>
                    
                    <div class="space-y-4 flex-1 overflow-y-auto">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Paciente</label>
                            <input type="text" id="nombrePacienteMinas" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="Ej. Juan P√©rez">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Nacimiento</label>
                            <input type="date" id="nacimientoPacienteMinas" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 outline-none">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">No. de Orden</label>
                                <input type="text" id="ordenPacienteMinas" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="Ej. 12345">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Folio HC</label>
                                <input type="text" id="folioPacienteMinas" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="Ej. HC-987">
                            </div>
                        </div>
                        <div class="pt-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Estudios Exclusivos (MINAS):</label>
                            <div class="flex flex-col gap-2">
                                <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-yellow-50 cursor-pointer transition">
                                    <input type="checkbox" value="Historia Cl√≠nica" class="cb-minas text-yellow-500 h-5 w-5 rounded">
                                    <span class="text-sm font-bold text-gray-700">Historia Cl√≠nica</span>
                                </label>
                                <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-yellow-50 cursor-pointer transition">
                                    <input type="checkbox" value="Espirometr√≠a" class="cb-minas text-yellow-500 h-5 w-5 rounded">
                                    <span class="text-sm font-bold text-gray-700">Espirometr√≠a</span>
                                </label>
                                <label class="flex items-center space-x-3 p-3 border rounded-lg hover:bg-yellow-50 cursor-pointer transition">
                                    <input type="checkbox" value="Audiometr√≠a" class="cb-minas text-yellow-500 h-5 w-5 rounded">
                                    <span class="text-sm font-bold text-gray-700">Audiometr√≠a</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <button onclick="agregarPacienteMinas()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 mt-4 rounded shadow-md transition">
                        + Crear Expediente MINAS
                    </button>
                </div>
                
                <div class="w-full lg:w-2/3 flex flex-col space-y-4">
                    
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                        <div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-yellow-500">
                            <p class="text-[10px] text-gray-500 font-bold uppercase">Pacientes Hoy</p>
                            <p id="stat-minas-hoy" class="text-2xl font-black text-gray-800">0</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-green-500">
                            <p class="text-[10px] text-gray-500 font-bold uppercase">Completados 100%</p>
                            <p id="stat-minas-completados" class="text-2xl font-black text-green-600">0%</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-blue-500 col-span-2 flex flex-col justify-center">
                            <p class="text-[10px] text-gray-500 font-bold uppercase mb-1">Avance de Aprobaci√≥n por Estudio</p>
                            <div class="flex justify-between text-xs font-bold">
                                <span class="text-blue-700">HC: <span id="stat-progreso-hc">0%</span></span>
                                <span class="text-indigo-700">Espiro: <span id="stat-progreso-espiro">0%</span></span>
                                <span class="text-purple-700">Audio: <span id="stat-progreso-audio">0%</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-3">
                        <div class="flex-1 bg-white flex items-center px-4 rounded-lg shadow-sm border border-gray-200">
                            <span>üîç</span>
                                <div class="flex space-x-2 mb-2">
                                        <button onclick="setFiltroMinas('todos')" id="btn-filtro-todos" class="px-4 py-1 text-xs font-bold rounded-full bg-gray-800 text-white transition shadow-sm">Todos</button>
                                        <button onclick="setFiltroMinas('pendientes')" id="btn-filtro-pendientes" class="px-4 py-1 text-xs font-bold rounded-full bg-white border border-gray-300 text-gray-600 hover:bg-gray-100 transition shadow-sm">‚ö†Ô∏è Requieren Acci√≥n</button>
                                        <button onclick="setFiltroMinas('rechazados')" id="btn-filtro-rechazados" class="px-4 py-1 text-xs font-bold rounded-full bg-white border border-gray-300 text-gray-600 hover:bg-gray-100 transition shadow-sm">‚ùå Rechazados IA</button>
                                </div>
                            <input type="text" id="buscadorMinas" onkeyup="renderizarExpedientesMinas()" class="w-full p-3 bg-transparent outline-none text-sm font-medium text-gray-700" placeholder="Buscar por Nombre, No. Orden o Folio HC...">
                        </div>
                        <button onclick="exportarExcelMinas()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-sm transition flex items-center whitespace-nowrap">
                            üìä Descargar Excel
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm flex-1 flex flex-col border-t border-gray-200">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 class="font-bold text-gray-700 text-lg">Control de Expedientes Integrales</h3>
                        </div>
                        <div id="contenedorExpedientesMinas" class="flex-1 overflow-y-auto space-y-6 pr-2">
                            <p class="text-center text-gray-400 mt-10 italic">A√±ade pacientes para gestionar sus expedientes integrales.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="vista-registro" class="hidden h-full flex flex-col lg:flex-row gap-6">
                <div class="bg-white p-6 rounded-lg shadow-sm w-full lg:w-1/2 border-t-4 border-lapiOrange flex flex-col">
                    <h3 class="font-bold text-gray-700 mb-4 text-lg">Nuevo Registro de Paciente</h3>
                    
                    <div id="drop-zone-red" 
                         ondragenter="event.preventDefault(); event.stopPropagation();"
                         ondragover="event.preventDefault(); event.stopPropagation(); this.classList.add('bg-orange-100', 'border-lapiOrange');" 
                         ondragleave="event.preventDefault(); event.stopPropagation(); this.classList.remove('bg-orange-100', 'border-lapiOrange');" 
                         ondrop="event.preventDefault(); event.stopPropagation(); this.classList.remove('bg-orange-100', 'border-lapiOrange'); procesarLoteArchivosRed(event.dataTransfer.files);"
                         class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center bg-gray-50 hover:bg-orange-50 transition cursor-pointer mb-4"
                         onclick="document.getElementById('file-upload-lote-red').click()">
                        <div class="pointer-events-none">
                            <p class="text-sm text-gray-700 font-bold">üì• Extracci√≥n M√°gica: Arrastra PDFs aqu√≠ (M√°x. 5 a la vez)</p>
                            <p class="text-[10px] text-gray-500 mt-1">Da clic o arrastra. La IA registrar√° al paciente y cargar√° sus estudios al M√≥dulo Documental.</p>
                        </div>
                        <input type="file" id="file-upload-lote-red" multiple accept="application/pdf" class="hidden" onchange="procesarLoteArchivosRed(this.files)">
                    </div>

                    <div class="space-y-4 flex-1 overflow-y-auto pr-2">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                            <div><label class="block text-sm font-medium text-gray-600 mb-1">Nombre Completo</label><input type="text" id="nombrePaciente" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-lapiOrange outline-none"></div>
                            <div><label class="block text-sm font-medium text-gray-600 mb-1">Fecha de Nacimiento</label><input type="date" id="nacimientoPaciente" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-lapiOrange outline-none"></div>
                            <div><label class="block text-sm font-medium text-gray-600 mb-1">No. de Orden</label><input type="text" id="ordenPaciente" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-lapiOrange outline-none"></div>
                            <div><label class="block text-sm font-medium text-gray-600 mb-1">Folio HC</label><input type="text" id="folioPaciente" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-lapiOrange outline-none"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">Estudios Realizados:</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2 p-2 border rounded hover:bg-lapiLight cursor-pointer"><input type="checkbox" value="Electrocardiograma" class="estudio-cb text-lapiOrange h-4 w-4"><span class="text-sm font-medium">Electrocardiograma</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded hover:bg-lapiLight cursor-pointer"><input type="checkbox" value="Historia Cl√≠nica" class="estudio-cb text-lapiOrange h-4 w-4"><span class="text-sm font-medium">Historia Cl√≠nica</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded hover:bg-lapiLight cursor-pointer"><input type="checkbox" value="Espirometr√≠a" class="estudio-cb text-lapiOrange h-4 w-4"><span class="text-sm font-medium">Espirometr√≠a</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded hover:bg-lapiLight cursor-pointer"><input type="checkbox" value="Audiometr√≠a" class="estudio-cb text-lapiOrange h-4 w-4"><span class="text-sm font-medium">Audiometr√≠a</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded hover:bg-lapiLight cursor-pointer"><input type="checkbox" value="N√≥rdico" class="estudio-cb text-lapiOrange h-4 w-4"><span class="text-sm font-medium">Cuest. N√≥rdico</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded hover:bg-lapiLight cursor-pointer"><input type="checkbox" value="EXCAVIS" class="estudio-cb text-lapiOrange h-4 w-4"><span class="text-sm font-medium">EXCAVIS</span></label>
                                <label class="flex items-center space-x-2 p-2 border rounded hover:bg-lapiLight cursor-pointer"><input type="checkbox" value="Timpanometr√≠a" class="estudio-cb text-lapiOrange h-4 w-4"><span class="text-sm font-medium">Timpanometr√≠a</span></label>
                            </div>
                        </div>
                    </div>
                    <button onclick="agregarPaciente()" class="w-full bg-lapiOrange text-white font-bold py-3 mt-4 rounded shadow-md hover:bg-lapiDark">+ Guardar Registro</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm w-full lg:w-1/2 flex flex-col">
                    <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-gray-700 text-lg">Pacientes de Hoy</h3><span id="contador-pacientes" class="bg-gray-200 text-xs font-bold px-2 py-1 rounded-full">0</span></div>
                    <ul id="listaPacientes" class="space-y-3 text-sm flex-1 overflow-y-auto pr-2"></ul>
                </div>
            </section>

            <section id="vista-carga" class="hidden h-full flex flex-col space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-blue-400"><p class="text-xs text-gray-500 font-medium">Estudios Registrados</p><p id="sucursal-estudios" class="text-2xl font-bold text-gray-800">0</p></div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-lapiOrange"><p class="text-xs text-gray-500 font-medium">Tu Progreso de Carga</p><p id="sucursal-carga" class="text-2xl font-bold text-gray-800">0%</p></div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border-l-4 border-green-400"><p class="text-xs text-gray-500 font-medium">Tu Aprobaci√≥n LAP.IA</p><p id="sucursal-ia" class="text-2xl font-bold text-gray-800">0%</p></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm flex-1 flex flex-col border-t-4 border-lapiOrange">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-gray-100">
                        <div><h3 class="font-bold text-gray-700 text-lg">M√≥dulo de An√°lisis LAP.IA</h3></div>
                        <select id="filtro-sucursal" onchange="generarCajasDeCarga()" class="border border-gray-300 text-sm rounded p-1 text-gray-600 focus:ring-lapiOrange outline-none"><option value="registro">Ordenar por: Registro</option><option value="paciente">Ordenar por: Paciente</option><option value="estudio">Ordenar por: Tipo de Estudio</option></select>
                    </div>
                    <div id="contenedorArchivos" class="flex-1 overflow-y-auto space-y-3 pr-2 pb-4"></div>
                </div>
            </section>

            <section id="vista-analisis-libre" class="hidden h-full flex flex-col lg:flex-row gap-6">
                <div class="bg-white p-6 rounded-lg shadow-sm w-full lg:w-1/3 border-t-4 border-gray-800 flex flex-col h-full">
                    <h3 class="font-bold text-gray-800 mb-2 text-lg">An√°lisis Independiente</h3>
                    <p class="text-xs text-gray-500 mb-6">Sube un archivo PDF real. Nuestra IA lo leer√° en vivo y aplicar√° el checklist m√©dico estructurado.</p>
                    
                    <div class="space-y-4 flex-1">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">1. Selecciona el tipo de documento:</label>
                            <select id="libre-tipo" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-lapiOrange outline-none">
                                <option value="Historia Cl√≠nica (Libre)">Historia Cl√≠nica (Integrado a IA)</option>
                                <option value="Electrocardiograma">Electrocardiograma (Integrado a IA)</option>
                                <option value="Espirometr√≠a">Espirometr√≠a (Pr√≥ximamente)</option>
                                <option value="Audiometr√≠a">Audiometr√≠a (Pr√≥ximamente)</option>
                            </select>
                        </div>
                        
                        <input type="file" id="input-pdf-real" accept="application/pdf" class="hidden" onchange="procesarPDFLocal(event)">
                        
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition cursor-pointer" onclick="document.getElementById('input-pdf-real').click()">
                            <span id="libre-icono-subida" class="text-4xl block mb-2">üìÅ</span>
                            <p id="libre-texto-subida" class="text-sm font-bold text-gray-600 break-words">Haz clic para adjuntar PDF</p>
                        </div>
                    </div>
                    <button id="btn-libre-analizar" onclick="llamarAGeminiAPI()" class="w-full bg-gray-800 text-white font-bold py-3 mt-4 rounded shadow-md opacity-50 cursor-not-allowed transition flex justify-center items-center" disabled>
                        ‚ú® Ejecutar LAP.IA
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm w-full lg:w-2/3 flex flex-col border-t-4 border-gray-200">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-bold text-gray-700 text-lg">Resultados del Checklist</h3>
                        <span id="libre-status" class="bg-gray-100 text-gray-500 text-xs font-bold px-3 py-1 rounded-full border border-gray-200">Esperando PDF...</span>
                    </div>
                    <div id="libre-resultados" class="flex-1 overflow-y-auto bg-gray-50 rounded p-4 border border-gray-100 flex items-center justify-center">
                        <p class="text-gray-400 italic text-sm text-center">Sube un PDF de Historia Cl√≠nica y presiona el bot√≥n para procesarlo con IA.</p>
                    </div>
                </div>
            </section>

        </div>
    </main>

        <div id="modal-editar-paciente" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-lg font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Expediente</h3>
            <input type="hidden" id="edit-id-paciente">
            <div class="space-y-3">
                <div><label class="block text-xs font-bold text-gray-600">Nombre</label><input type="text" id="edit-nombre" class="w-full p-2 border rounded outline-none text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-600">Fecha Nacimiento</label><input type="date" id="edit-nacimiento" class="w-full p-2 border rounded outline-none text-sm"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-bold text-gray-600">No. Orden</label><input type="text" id="edit-orden" class="w-full p-2 border rounded outline-none text-sm"></div>
                    <div><label class="block text-xs font-bold text-gray-600">Folio HC</label><input type="text" id="edit-folio" class="w-full p-2 border rounded outline-none text-sm"></div>
                </div>
                <div class="pt-2">
                    <label class="block text-xs font-bold text-gray-600 mb-2">Estudios del Expediente:</label>
                    <div class="flex flex-col gap-2 bg-gray-50 p-3 rounded border">
                        <label class="flex items-center space-x-2 text-sm"><input type="checkbox" value="Historia Cl√≠nica" class="edit-cb-estudio h-4 w-4 text-yellow-500"><span>Historia Cl√≠nica</span></label>
                        <label class="flex items-center space-x-2 text-sm"><input type="checkbox" value="Espirometr√≠a" class="edit-cb-estudio h-4 w-4 text-yellow-500"><span>Espirometr√≠a</span></label>
                        <label class="flex items-center space-x-2 text-sm"><input type="checkbox" value="Audiometr√≠a" class="edit-cb-estudio h-4 w-4 text-yellow-500"><span>Audiometr√≠a</span></label>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="document.getElementById('modal-editar-paciente').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded hover:bg-gray-300">Cancelar</button>
                <button onclick="guardarEdicionPaciente()" class="px-4 py-2 bg-yellow-500 text-white font-bold rounded hover:bg-yellow-600">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <div id="modal-editar-paciente-red" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-2xl border-t-4 border-lapiOrange">
            <h3 class="text-lg font-bold text-gray-800 mb-4">‚úèÔ∏è Editar Expediente (Sucursal)</h3>
            <input type="hidden" id="edit-id-paciente-red">
            <div class="space-y-3">
                <div><label class="block text-xs font-bold text-gray-600">Nombre</label><input type="text" id="edit-nombre-red" class="w-full p-2 border rounded outline-none text-sm focus:ring-2 focus:ring-lapiOrange"></div>
                <div><label class="block text-xs font-bold text-gray-600">Fecha Nacimiento</label><input type="date" id="edit-nacimiento-red" class="w-full p-2 border rounded outline-none text-sm focus:ring-2 focus:ring-lapiOrange"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-bold text-gray-600">No. Orden</label><input type="text" id="edit-orden-red" class="w-full p-2 border rounded outline-none text-sm focus:ring-2 focus:ring-lapiOrange"></div>
                    <div><label class="block text-xs font-bold text-gray-600">Folio HC</label><input type="text" id="edit-folio-red" class="w-full p-2 border rounded outline-none text-sm focus:ring-2 focus:ring-lapiOrange"></div>
                </div>
                <div class="pt-2">
                    <label class="block text-xs font-bold text-gray-600 mb-2">Estudios del Expediente:</label>
                    <div class="grid grid-cols-2 gap-2 bg-gray-50 p-3 rounded border">
                        <label class="flex items-center space-x-2 text-xs"><input type="checkbox" value="Electrocardiograma" class="edit-cb-red text-lapiOrange h-3 w-3"><span>Electrocardiograma</span></label>
                        <label class="flex items-center space-x-2 text-xs"><input type="checkbox" value="Historia Cl√≠nica" class="edit-cb-red text-lapiOrange h-3 w-3"><span>Historia Cl√≠nica</span></label>
                        <label class="flex items-center space-x-2 text-xs"><input type="checkbox" value="Espirometr√≠a" class="edit-cb-red text-lapiOrange h-3 w-3"><span>Espirometr√≠a</span></label>
                        <label class="flex items-center space-x-2 text-xs"><input type="checkbox" value="Audiometr√≠a" class="edit-cb-red text-lapiOrange h-3 w-3"><span>Audiometr√≠a</span></label>
                        <label class="flex items-center space-x-2 text-xs"><input type="checkbox" value="N√≥rdico" class="edit-cb-red text-lapiOrange h-3 w-3"><span>Cuest. N√≥rdico</span></label>
                        <label class="flex items-center space-x-2 text-xs"><input type="checkbox" value="EXCAVIS" class="edit-cb-red text-lapiOrange h-3 w-3"><span>EXCAVIS</span></label>
                        <label class="flex items-center space-x-2 text-xs"><input type="checkbox" value="Timpanometr√≠a" class="edit-cb-red text-lapiOrange h-3 w-3"><span>Timpanometr√≠a</span></label>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="document.getElementById('modal-editar-paciente-red').classList.add('hidden')" class="px-4 py-2 bg-gray-200 text-gray-700 font-bold rounded hover:bg-gray-300">Cancelar</button>
                <button onclick="guardarEdicionPacienteRed()" class="px-4 py-2 bg-lapiOrange text-white font-bold rounded hover:bg-lapiDark">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <div id="overlay-carga-lote" class="hidden fixed inset-0 bg-white bg-opacity-90 z-50 flex flex-col items-center justify-center p-4">
        <div class="animate-spin text-5xl mb-4">üß†</div>
        <h2 class="text-xl font-bold text-gray-800 text-center">Extrayendo Datos con IA...</h2>
        <p id="texto-estado-lote" class="text-sm text-gray-500 mt-2 font-medium">Procesando archivo 1 de 3</p>
    </div>
        
    <script>
        // ==============================================================================
        // CONFIGURACI√ìN DE IA Y API (Laboratorio)
        // ==============================================================================
        let pdfBase64Actual = null;

        // ==============================================================================
        // CONFIGURACI√ìN DE FIREBASE (Base de Datos)
        // ==============================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyB33kiieeRUBqwS2zIJQHeNdGmAK06sn8M",
            authDomain: "lapi-ea60d.firebaseapp.com",
            projectId: "lapi-ea60d",
            storageBucket: "lapi-ea60d.firebasestorage.app",
            messagingSenderId: "279896629954",
            appId: "1:279896629954:web:dfca8fd4917eec284a115b",
            measurementId: "G-BGN0XPBD0E"
        };

        let db = null;
        let storage = null; // NUEVA VARIABLE PARA EL VISOR
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage(); // INICIAMOS STORAGE
            console.log("Conexi√≥n a Firebase Base de Datos Iniciada.");
        } catch(e) {
            console.warn("Aviso: Firebase local.");
        }

        
        async function guardarPDFEnStorage(base64, idPaciente, tipoDoc) {
            if (!storage) return null;
            try {
                // Se guardan ordenados por d√≠a operativo
                const ruta = `visores_temporales/${fechaActualStr}/${idPaciente}_${tipoDoc.replace(/\s+/g, '')}.pdf`;
                const ref = storage.ref().child(ruta);
                await ref.putString(base64, 'base64', { contentType: 'application/pdf' });
                return await ref.getDownloadURL();
            } catch(e) {
                console.error("Error al crear visor:", e);
                return null;
            }
        }

        async function cargarPacientesMinasDesdeFirebase() {
            if (!db) return;
            mostrarCarga('Descargando expedientes MINAS...');
            try {
                // Buscamos los pacientes de la fecha seleccionada
                const snapshot = await db.collection("PacientesMinas")
                                         .where("fechaOperativa", "==", fechaActualStr)
                                         .get();
                
                // Limpiamos la memoria local temporal
                bdMinas[fechaActualStr] = { pacientes: [] };
                
                // Llenamos la memoria con los datos reales de la base de datos
                snapshot.forEach(doc => {
                    bdMinas[fechaActualStr].pacientes.push(doc.data());
                });
                
                // Le decimos a la pantalla que se dibuje de nuevo
                renderizarExpedientesMinas();
            } catch (error) {
            finally { ocultarCarga(); }
                console.error("Error al descargar desde Firebase:", error);
            }
        }
        
        function procesarPDFLocal(event) {
            const file = event.target.files[0];
            if (file && file.type === "application/pdf") {
                const reader = new FileReader();
                reader.onload = function(e) {
                    pdfBase64Actual = e.target.result.split(',')[1];
                    document.getElementById('libre-icono-subida').textContent = 'üìÑ';
                    document.getElementById('libre-texto-subida').textContent = file.name;
                    document.getElementById('libre-texto-subida').classList.add('text-lapiOrange');
                    const btn = document.getElementById('btn-libre-analizar');
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.disabled = false;
                };
                reader.readAsDataURL(file);
            } else {
                mostrarToast("Por favor, selecciona un archivo PDF v√°lido.");
            }
        }
        
        async function llamarAGeminiAPI() {
            if (!pdfBase64Actual) return;
            const tipo = document.getElementById('libre-tipo').value;
            const btn = document.getElementById('btn-libre-analizar');
            const panel = document.getElementById('libre-resultados');
            const badge = document.getElementById('libre-status');
            
            btn.disabled = true;
            btn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div> Analizando PDF...`;
            badge.className = "bg-orange-100 text-lapiOrange text-xs font-bold px-3 py-1 rounded-full border border-orange-200 animate-pulse";
            badge.textContent = "üß† IA Leyendo Documento...";
            panel.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center space-y-4"><div class="w-10 h-10 border-4 border-lapiOrange border-t-transparent rounded-full animate-spin"></div><p class="text-gray-500 font-bold animate-pulse text-center">Enviando a servidor seguro...<br><span class="text-xs font-normal">Esto puede tardar hasta 15 segundos</span></p></div>`;

            try {
                const response = await fetch('/.netlify/functions/analizarDocumento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pdfBase64: pdfBase64Actual, tipoDocumento: tipo })
                });

                const responseText = await response.text();
                if (!response.ok) {
                    try {
                        const errorObj = JSON.parse(responseText);
                        throw new Error(errorObj.error || `Error 500 Interno`);
                    } catch(e) {
                        throw new Error(`Falla del servidor Netlify: ${responseText.substring(0, 100)}...`);
                    }
                }
                const resultadoIA = JSON.parse(responseText);
                mostrarResultadosAPI(resultadoIA, tipo);
            } catch (error) {
                console.error("Error capturado:", error);
                badge.className = "bg-red-100 text-red-700 text-xs font-bold px-3 py-1 rounded-full";
                badge.textContent = "Error de Conexi√≥n";
                panel.innerHTML = `<div class="text-center w-full"><p class="text-red-500 text-sm font-bold mb-2">Error del Backend.</p><p class="text-xs text-gray-700 max-w-md mx-auto mb-4 bg-red-50 p-3 rounded border border-red-200 font-mono text-left">${error.message}</p><button onclick="resetLibre()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded text-sm font-bold hover:bg-gray-300">‚Üª Intentar de nuevo</button></div>`;
            } finally {
                btn.innerHTML = `‚ú® Ejecutar LAP.IA`;
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        function mostrarResultadosAPI(resultado, tipo) {
            const badge = document.getElementById('libre-status');
            const panel = document.getElementById('libre-resultados');
            badge.className = resultado.aprobadoGeneral ? "bg-green-100 text-green-700 text-xs font-bold px-3 py-1 rounded-full border border-green-300" : "bg-red-100 text-red-700 text-xs font-bold px-3 py-1 rounded-full border border-red-300";
            badge.textContent = resultado.aprobadoGeneral ? "‚úÖ Aprobado por IA" : "‚ùå Rechazado por IA";
            panel.className = "flex-1 overflow-y-auto bg-white p-0 border-none flex items-start justify-start";
            
            let htmlChecklist = `<div class="w-full"><h4 class="text-sm font-bold text-gray-600 mb-3 border-b pb-2">Reporte de Auditor√≠a: <span class="text-lapiOrange">${tipo}</span></h4>`;
            if (!resultado.aprobadoGeneral) htmlChecklist += `<div class="bg-red-50 border-l-4 border-red-500 p-3 mb-4 rounded"><p class="text-xs text-red-700 font-bold">Falla Cr√≠tica Detectada:</p><p class="text-sm text-red-800">${resultado.motivoPrincipal}</p></div>`;
            htmlChecklist += `<ul class="space-y-3">`;
            resultado.checklist.forEach(item => {
                const bgClass = item.pass ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                const icon = item.pass ? '‚úÖ' : '‚ùå';
                const titleColor = item.pass ? 'text-green-800' : 'text-red-800';
                htmlChecklist += `<li class="flex items-start p-3 rounded border ${bgClass}"><span class="mr-3 mt-0.5">${icon}</span><div><span class="text-sm font-bold ${titleColor} block">${item.categoria}</span><span class="text-xs text-gray-600 mt-1 block">${item.comentario}</span></div></li>`;
            });
            htmlChecklist += `</ul><div class="mt-6 p-4 bg-gray-50 rounded text-xs text-gray-500 text-center border border-gray-200"><button onclick="resetLibre()" class="text-lapiOrange hover:text-lapiDark font-bold transition">‚Üª Auditar un nuevo documento PDF</button></div></div>`;
            panel.innerHTML = htmlChecklist;
        }

        function resetLibre() {
            pdfBase64Actual = null;
            document.getElementById('input-pdf-real').value = ""; 
            document.getElementById('libre-icono-subida').textContent = 'üìÅ'; document.getElementById('libre-texto-subida').textContent = 'Haz clic para adjuntar PDF'; document.getElementById('libre-texto-subida').classList.remove('text-lapiOrange');
            document.getElementById('btn-libre-analizar').classList.add('opacity-50', 'cursor-not-allowed'); document.getElementById('btn-libre-analizar').disabled = true;
            document.getElementById('libre-status').className = "bg-gray-100 text-gray-500 text-xs font-bold px-3 py-1 rounded-full border border-gray-200"; document.getElementById('libre-status').textContent = "Esperando PDF...";
            document.getElementById('libre-resultados').className = "flex-1 overflow-y-auto bg-gray-50 rounded p-4 border border-gray-100 flex items-center justify-center"; document.getElementById('libre-resultados').innerHTML = '<p class="text-gray-400 italic text-sm text-center">Sube un PDF de Historia Cl√≠nica y presiona el bot√≥n para procesarlo con IA.</p>';
        }

        // ==============================================================================
        // ESTRUCTURAS DE DATOS GLOBALES
        // ==============================================================================
        const SUCURSALES = ["Balbuena", "Hospital General", "Condesa", "Metepec", "Cuautitl√°n", "Lindavista", "Lomas Verdes", "Sat√©lite", "Encuentro Fortuna", "Mart√≠n Carrera", "Santa Martha", "Plaza Central", "Santa Fe", "Interlomas", "Polanco", "City Shop Del Valle", "Miramontes", "Plateros", "Revoluci√≥n", "Gabriel Mancera", "Calzada Del Hueso", "Gran Sur", "General Anaya", "Mixcoac", "Plaza San Jer√≥nimo", "Amores"].sort(); 
        let bdGlobal = {}; let bdMinas = {}; // NUEVO: Base de datos aislada para MINAS
        let fechaActualStr = ''; let sucursalActual = ''; let rolActual = ''; let sucursalAuditada = ''; let docKeyActivo = ''; 

        window.onload = () => { 
            const selector = document.getElementById('selector-acceso'); SUCURSALES.forEach(sucursal => { const option = document.createElement('option'); option.value = sucursal; option.textContent = `üìç Sucursal - ${sucursal}`; selector.appendChild(option); }); 
            generarDirectorioUI(); 
            const inputFecha = document.getElementById('fecha-global'); inputFecha.valueAsDate = new Date(); fechaActualStr = inputFecha.value; 
        };

        function inicializarDiaYSucursal() { 
            if (!bdGlobal[fechaActualStr]) bdGlobal[fechaActualStr] = {}; 
            if (sucursalActual !== 'admin' && sucursalActual !== '' && !bdGlobal[fechaActualStr][sucursalActual]) bdGlobal[fechaActualStr][sucursalActual] = { pacientes: [], docsStatus: {} }; 
            // NUEVO: Inicializar base de datos MINAS si no existe en la fecha
            if (!bdMinas[fechaActualStr]) bdMinas[fechaActualStr] = { pacientes: [] };
        }
        
        function cambiarFecha() { 
            fechaActualStr = document.getElementById('fecha-global').value; 
            inicializarDiaYSucursal(); 
            
            if (rolActual !== '') {
                actualizarUI();
                if (rolActual === 'admin') {
                    cargarPacientesMinasDesdeFirebase();
                }
                // CR√çTICO: Descargar tambi√©n los de la red al cambiar de d√≠a
                cargarPacientesRedDesdeFirebase(); 
            } 
        }

        function iniciarSesion() {
            const acceso = document.getElementById('selector-acceso').value;
            rolActual = acceso === 'admin' ? 'admin' : 'sucursal'; sucursalActual = acceso === 'admin' ? '' : acceso;
            inicializarDiaYSucursal();
            
            document.getElementById('pantalla-login').classList.add('hidden'); 
            document.getElementById('sidebar').classList.remove('hidden'); 
            document.getElementById('sidebar').classList.add('flex'); 
            document.getElementById('contenido-principal').classList.remove('hidden');
            document.getElementById('usuario-actual').textContent = rolActual === 'admin' ? 'Administrador LAPI' : `${sucursalActual}`;
            
            if (rolActual === 'admin') { 
                ['btn-nav-admin', 'btn-nav-directorio', 'btn-nav-minas'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.remove('hidden');
                }); 
                ['btn-nav-registro', 'btn-nav-carga'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.add('hidden');
                }); 
                
                // CR√çTICO: Descargar datos de ambos mundos para el Admin
                cargarPacientesMinasDesdeFirebase();
                cargarPacientesRedDesdeFirebase(); 
            } else { 
                ['btn-nav-admin', 'btn-nav-directorio', 'btn-nav-minas'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.add('hidden');
                }); 
                ['btn-nav-registro', 'btn-nav-carga'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.classList.remove('hidden');
                }); 
                
                // CR√çTICO: Descargar datos de la red para la Sucursal
                cargarPacientesRedDesdeFirebase(); 
            }
            
            mostrarVista('vista-inicio', document.getElementById('btn-nav-inicio'));
            actualizarUI();
        }

        function cerrarSesion() { rolActual = ''; sucursalActual = ''; document.getElementById('pantalla-login').classList.remove('hidden'); document.getElementById('sidebar').classList.add('hidden'); document.getElementById('contenido-principal').classList.add('hidden'); }

        function renderizarInicio() {
            const grid = document.getElementById('grid-inicio');
            grid.innerHTML = '';
            if (rolActual === 'admin') {
                grid.innerHTML += `
                    <div onclick="mostrarVista('vista-admin', document.getElementById('btn-nav-admin'))" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg cursor-pointer transition border-t-4 border-blue-500">
                        <div class="text-4xl mb-3">üìä</div><h3 class="font-bold text-gray-800 text-lg">Panel de Red</h3><p class="text-sm text-gray-500">Auditor√≠a global de sucursales</p>
                    </div>
                    <div onclick="mostrarVista('vista-minas', document.getElementById('btn-nav-minas'))" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg cursor-pointer transition border-t-4 border-yellow-500">
                        <div class="text-4xl mb-3">‚õèÔ∏è</div><h3 class="font-bold text-gray-800 text-lg">M√≥dulo MINAS</h3><p class="text-sm text-gray-500">Expedientes integrales especiales</p>
                    </div>
                    <div onclick="mostrarVista('vista-analisis-libre', document.getElementById('btn-nav-libre'))" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg cursor-pointer transition border-t-4 border-gray-800">
                        <div class="text-4xl mb-3">üß†</div><h3 class="font-bold text-gray-800 text-lg">Laboratorio LAP.IA</h3><p class="text-sm text-gray-500">Auditor√≠a de PDFs en vivo</p>
                    </div>`;
            } else {
                grid.innerHTML += `
                    <div onclick="mostrarVista('vista-registro', document.getElementById('btn-nav-registro'))" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg cursor-pointer transition border-t-4 border-blue-500">
                        <div class="text-4xl mb-3">üìù</div><h3 class="font-bold text-gray-800 text-lg">Registro Diario</h3><p class="text-sm text-gray-500">Ingreso de pacientes</p>
                    </div>
                    <div onclick="mostrarVista('vista-carga', document.getElementById('btn-nav-carga'))" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg cursor-pointer transition border-t-4 border-lapiOrange">
                        <div class="text-4xl mb-3">üìÅ</div><h3 class="font-bold text-gray-800 text-lg">Gesti√≥n Documental</h3><p class="text-sm text-gray-500">Carga y revisi√≥n inteligente</p>
                    </div>
                    <div onclick="mostrarVista('vista-analisis-libre', document.getElementById('btn-nav-libre'))" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg cursor-pointer transition border-t-4 border-gray-800">
                        <div class="text-4xl mb-3">üß†</div><h3 class="font-bold text-gray-800 text-lg">Laboratorio LAP.IA</h3><p class="text-sm text-gray-500">An√°lisis libre de documentos</p>
                    </div>`;
            }
        }

        function mostrarVista(idVista, btnElement) {
            ['vista-inicio', 'vista-admin', 'vista-admin-directorio', 'vista-admin-detalle', 'vista-minas', 'vista-registro', 'vista-carga', 'vista-analisis-libre'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            document.querySelectorAll('#sidebar nav button').forEach(b => {
                b.classList.remove('bg-gray-800', 'border-l-4', 'border-lapiOrange');
            });
            
            const elementToShow = document.getElementById(idVista);
            if(elementToShow) elementToShow.classList.remove('hidden');
            
            // Flex handling specifically for launchpad
            if(idVista === 'vista-inicio') elementToShow.classList.add('flex');
            else document.getElementById('vista-inicio').classList.remove('flex');

            if(btnElement) btnElement.classList.add('bg-gray-800', 'border-l-4', 'border-lapiOrange');
            
            const titulos = { 
                'vista-inicio': 'P√°gina Principal',
                'vista-admin': 'Panel de Control de Red LAP.IA', 
                'vista-admin-directorio': 'Directorio Operativo de Red', 
                'vista-admin-detalle': 'Auditor√≠a Documental', 
                'vista-minas': 'Gesti√≥n de Expedientes MINAS',
                'vista-registro': `Registro - ${sucursalActual}`, 
                'vista-carga': `An√°lisis LAP.IA - ${sucursalActual}`, 
                'vista-analisis-libre': 'Laboratorio de Calidad LAP.IA' 
            };
            document.getElementById('titulo-vista').textContent = titulos[idVista];
            
            if(idVista === 'vista-inicio') renderizarInicio();
            actualizarUI();
        }

        function actualizarUI() {
            if (!rolActual) return;
            if (rolActual === 'admin') {
                actualizarDashboardAdmin(); 
                if (!document.getElementById('vista-admin-detalle').classList.contains('hidden')) generarVistaDetalleAdmin();
                if (!document.getElementById('vista-minas').classList.contains('hidden')) renderizarExpedientesMinas();
            } else {
                actualizarListaPacientes(); generarCajasDeCarga(); actualizarEstadisticasLocales(sucursalActual, 'sucursal');
            }
        }

        async function agregarPacienteMinas() {
            const inputNombre = document.getElementById('nombrePacienteMinas'); 
            const inputNacimiento = document.getElementById('nacimientoPacienteMinas'); 
            const inputOrden = document.getElementById('ordenPacienteMinas'); 
            const inputFolio = document.getElementById('folioPacienteMinas'); 
            const cbs = document.querySelectorAll('.cb-minas:checked');
            
            const nombre = inputNombre.value.trim();
            const nacimiento = inputNacimiento.value;
            const orden = inputOrden.value.trim();
            const folio = inputFolio.value.trim();

            if (nombre === '' || nacimiento === '' || (orden === '' && folio === '') || cbs.length === 0) { 
                mostrarToast('Faltan datos. Aseg√∫rate de ingresar Nombre, Fecha de Nacimiento, al menos un identificador (No. de Orden o Folio) y estudios.'); 
                return; 
            }

            // ==========================================
            // VALIDACI√ìN DE DUPLICADOS CORREGIDA
            // ==========================================
            const duplicado = bdMinas[fechaActualStr].pacientes.some(p => 
                (orden !== '' && p.numeroOrden === orden) || 
                (folio !== '' && p.folioHC === folio)
            );
            if (duplicado) {
                mostrarToast('‚ö†Ô∏è ERROR: Ya existe un paciente registrado HOY con ese N√∫mero de Orden o Folio HC. Por favor verifica.');
                return;
            }
            
            const estudiosSeleccionados = Array.from(cbs).map(cb => cb.value);
            let docsDelPaciente = {};
            estudiosSeleccionados.forEach(est => {
                if (est === 'Historia Cl√≠nica') docsDelPaciente['Historia Cl√≠nica'] = { estado: 'pendiente' };
                if (est === 'Espirometr√≠a') docsDelPaciente['Espirometr√≠a'] = { estado: 'pendiente' };
                if (est === 'Audiometr√≠a') docsDelPaciente['Audiometr√≠a'] = { estado: 'pendiente' };
            });

            const nuevoPaciente = { 
                id: Date.now().toString(), fechaOperativa: fechaActualStr, nombre: nombre, 
                fechaNacimiento: nacimiento, numeroOrden: orden, folioHC: folio,
                estudios: estudiosSeleccionados, docsStatus: docsDelPaciente, statusIntegral: 'pendiente', datosExtraidosHC: null
            };

            bdMinas[fechaActualStr].pacientes.push(nuevoPaciente);
            if(db) db.collection("PacientesMinas").doc(nuevoPaciente.id).set(nuevoPaciente).catch(e=>console.error(e));
            
            inputNombre.value = ''; inputOrden.value = ''; inputFolio.value = ''; cbs.forEach(cb => cb.checked = false); 
            renderizarExpedientesMinas();
        }

        let filtroActualMinas = 'todos';
        function setFiltroMinas(filtro) {
            filtroActualMinas = filtro;
            ['todos', 'pendientes', 'rechazados'].forEach(f => {
                const btn = document.getElementById(`btn-filtro-${f}`);
                if (btn) {
                    if (f === filtro) {
                        btn.classList.replace('bg-white', 'bg-gray-800');
                        btn.classList.replace('text-gray-600', 'text-white');
                        btn.classList.remove('border', 'border-gray-300', 'hover:bg-gray-100');
                    } else {
                        btn.classList.replace('bg-gray-800', 'bg-white');
                        btn.classList.replace('text-white', 'text-gray-600');
                        btn.classList.add('border', 'border-gray-300', 'hover:bg-gray-100');
                    }
                }
            });
            renderizarExpedientesMinas();
        }

        function renderizarExpedientesMinas() {
            const contenedor = document.getElementById('contenedorExpedientesMinas');
            contenedor.innerHTML = '';
            if(!bdMinas[fechaActualStr]) return;
            
            let pacientes = bdMinas[fechaActualStr].pacientes;
            document.getElementById('stat-minas-hoy').textContent = pacientes.length;
            
            let pacCompletados = 0; let reqHC = 0, reqEs = 0, reqAu = 0; let apHC = 0, apEs = 0, apAu = 0;

            pacientes.forEach(p => {
                const keys = Object.keys(p.docsStatus);
                const todosAprobados = keys.every(k => p.docsStatus[k].estado === 'aprobado');
                if (todosAprobados && keys.length > 0) pacCompletados++;
                if(p.docsStatus['Historia Cl√≠nica']) { reqHC++; if(p.docsStatus['Historia Cl√≠nica'].estado === 'aprobado') apHC++; }
                if(p.docsStatus['Espirometr√≠a']) { reqEs++; if(p.docsStatus['Espirometr√≠a'].estado === 'aprobado') apEs++; }
                if(p.docsStatus['Audiometr√≠a']) { reqAu++; if(p.docsStatus['Audiometr√≠a'].estado === 'aprobado') apAu++; }
            });

            document.getElementById('stat-minas-completados').textContent = pacientes.length > 0 ? Math.round((pacCompletados/pacientes.length)*100) + '%' : '0%';
            document.getElementById('stat-progreso-hc').textContent = reqHC > 0 ? Math.round((apHC/reqHC)*100) + '%' : '-';
            document.getElementById('stat-progreso-espiro').textContent = reqEs > 0 ? Math.round((apEs/reqEs)*100) + '%' : '-';
            document.getElementById('stat-progreso-audio').textContent = reqAu > 0 ? Math.round((apAu/reqAu)*100) + '%' : '-';

            // APLICAR B√öSQUEDA
            const terminoBusqueda = (document.getElementById('buscadorMinas')?.value || '').toLowerCase();
            if (terminoBusqueda !== '') {
                pacientes = pacientes.filter(p => p.nombre.toLowerCase().includes(terminoBusqueda) || p.numeroOrden.toLowerCase().includes(terminoBusqueda) || p.folioHC.toLowerCase().includes(terminoBusqueda));
            }

            // APLICAR FILTROS R√ÅPIDOS
            if (filtroActualMinas === 'pendientes') {
                pacientes = pacientes.filter(p => Object.values(p.docsStatus).some(d => d.estado === 'pendiente' || d.estado === 'subido'));
            } else if (filtroActualMinas === 'rechazados') {
                pacientes = pacientes.filter(p => Object.values(p.docsStatus).some(d => d.estado === 'rechazado'));
            }

            if(pacientes.length === 0) {
                contenedor.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-gray-400 fade-in">
                        <span class="text-6xl mb-4 opacity-50 grayscale">üìÇ</span>
                        <p class="text-lg font-bold text-gray-500">Bandeja Limpia</p>
                        <p class="text-sm mt-1">No hay expedientes que coincidan con la b√∫squeda actual.</p>
                    </div>`;
                return;
            }
            
            pacientes.forEach(p => {
                const docsKeys = Object.keys(p.docsStatus);
                const card = document.createElement('div');
                card.className = "border border-gray-200 rounded-lg p-4 bg-gray-50 shadow-sm fade-in mb-4";
                
                // AQU√ç EST√Å EL CAMBIO CON LOS DOS BOTONES (EDITAR Y ELIMINAR)
                let html = `
                    <div class="flex justify-between items-start mb-4 border-b border-gray-200 pb-3">
                        <div>
                            <h4 class="text-lg font-bold text-gray-800">üë§ ${p.nombre}</h4>
                            <div class="flex space-x-3 mt-1">
                                <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded">Ord: ${p.numeroOrden}</span>
                                <span class="bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-0.5 rounded">Folio: ${p.folioHC}</span>
                            </div>
                            <p class="text-xs font-medium text-gray-500 mt-2">${p.estudios.join(' ‚Ä¢ ')}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="abrirModalEditarMinas('${p.id}')" class="text-blue-500 hover:text-blue-700 text-[10px] font-bold px-2 py-1 border border-blue-200 bg-white rounded shadow-sm">‚úèÔ∏è Editar</button>
                            <button onclick="eliminarPacienteMinas('${p.id}')" class="text-red-500 hover:text-red-700 text-[10px] font-bold px-2 py-1 border border-red-200 bg-white rounded shadow-sm">‚úï Eliminar</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                `;

                docsKeys.forEach(docName => {
                    const statusObj = p.docsStatus[docName];
                    let docBtn = '';
                    let btnChecklist = (statusObj.estado === 'aprobado' || statusObj.estado === 'rechazado') ? `<button onclick="abrirModalChecklistMinas('${p.id}', '${docName}')" class="text-[10px] text-blue-500 hover:underline font-bold ml-2">üìã Detalles</button>` : '';

                    if (statusObj.estado === 'pendiente') {
                        docBtn = `<button onclick="accionDocMinasIndividual('${p.id}', '${docName}', 'subir')" class="text-xs bg-white border border-gray-300 px-3 py-1 rounded hover:bg-gray-100 font-bold">Subir Archivo</button>`; 
                    } else if (statusObj.estado === 'subido') {
                        docBtn = `<div class="flex items-center"><span class="text-xs text-gray-500 mr-2 font-bold">‚úì Subido</span> <button onclick="accionDocMinasIndividual('${p.id}', '${docName}', 'analizar')" class="text-[10px] bg-gray-800 text-white hover:bg-gray-900 px-2 py-1 rounded shadow-md font-bold transition">‚ú® Analizar</button></div>`; 
                    } else if (statusObj.estado === 'analizando') {
                        docBtn = `<span class="text-lapiOrange text-xs font-bold animate-pulse">üß† IA Analizando...</span>`; 
                    } else if (statusObj.estado === 'aprobado') {
                        docBtn = `<div class="flex items-center space-x-2"><span class="bg-green-100 text-green-700 border border-green-300 px-2 py-0.5 rounded text-[10px] font-bold flex items-center">‚úÖ Aprobado ${btnChecklist}</span> <button onclick="accionDocMinasIndividual('${p.id}', '${docName}', 'analizar')" class="text-[10px] text-blue-600 hover:text-blue-800 font-bold transition" title="Volver a auditar este documento">‚Üª Repetir</button> <button onclick="accionDocMinasIndividual('${p.id}', '${docName}', 'subir')" class="text-[10px] text-gray-400 hover:text-gray-600 underline">Resubir</button></div>`; 
                    } else if (statusObj.estado === 'rechazado') {
                        docBtn = `<div class="flex items-center space-x-2"><span class="bg-red-100 text-red-700 border border-red-300 px-2 py-0.5 rounded text-[10px] font-bold flex items-center">‚ùå Rechazado ${btnChecklist}</span> <button onclick="accionDocMinasIndividual('${p.id}', '${docName}', 'analizar')" class="text-[10px] text-blue-600 hover:text-blue-800 font-bold transition" title="Volver a auditar este documento">‚Üª Repetir</button> <button onclick="accionDocMinasIndividual('${p.id}', '${docName}', 'subir')" class="text-[10px] text-gray-400 hover:text-gray-600 underline">Resubir</button></div>`;
                    }

                    let divClasses = "relative overflow-hidden flex justify-between items-center p-2 rounded border ";
                    let animHTML = "";
                    if (statusObj.estado === 'analizando') {
                        divClasses += "bg-orange-50 border-orange-300 shadow-sm";
                        animHTML = `<div class="absolute inset-0 bg-gradient-to-r from-transparent via-orange-200 to-transparent opacity-50 animate-sweep"></div>`;
                    } else if (statusObj.estado === 'aprobado') { divClasses += "bg-green-50/50 border-green-200"; } 
                    else if (statusObj.estado === 'rechazado') { divClasses += "bg-red-50/50 border-red-200"; } 
                    else { divClasses += "bg-white border-gray-200"; }

                    html += `<div class="${divClasses}">${animHTML}<span class="relative z-10 text-sm text-gray-700 font-medium">${docName}</span><div class="relative z-10">${docBtn}</div></div>`;
                });

                html += `</div>`;
                card.innerHTML = html;
                contenedor.appendChild(card);
            });
        }

        

        function abrirModalChecklistMinas(idPaciente, docName) {
            const paciente = bdMinas[fechaActualStr].pacientes.find(p => p.id === idPaciente.toString() || p.id === idPaciente);
            if(!paciente || !paciente.docsStatus[docName].checklist) return;
            
            const checklist = paciente.docsStatus[docName].checklist;
            document.getElementById('checklist-subtitulo').textContent = `${docName} - ${paciente.nombre}`;
            const ul = document.getElementById('lista-checklist'); ul.innerHTML = '';
            
            checklist.forEach((item, index) => {
                // Colores por defecto (Verde IA, Rojo Rechazo)
                let bgClass = item.pass ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                let titleColor = item.pass ? 'text-green-800' : 'text-red-800';
                let iconHTML = '';
                
                if (item.manualOverride) {
                    // ESTADO MANUAL: Azul brillante para diferenciarlo de la IA
                    bgClass = 'bg-blue-50 border-blue-300';
                    titleColor = 'text-blue-800';
                    iconHTML = `
                        <div class="flex flex-col items-center mr-3 mt-0.5">
                            <button onclick="aprobarReglaManual('${paciente.id}', '${docName}', ${index})" class="hover:scale-110 transition bg-blue-500 text-white rounded-full w-7 h-7 flex items-center justify-center shadow-md cursor-pointer" title="Deshacer aprobaci√≥n manual">‚úîÔ∏è</button>
                            <span class="text-[9px] text-blue-700 font-extrabold uppercase mt-1 text-center leading-tight">Cambio<br>Manual</span>
                        </div>`;
                } else if (item.pass) {
                    // ESTADO APROBADO POR IA: Verde Normal
                    iconHTML = `<span class="mr-3 mt-0.5 cursor-default text-xl" title="Aprobado por IA">‚úÖ</span>`;
                } else {
                    // ESTADO RECHAZADO: Rojo con bot√≥n para Forzar Aprobaci√≥n
                    iconHTML = `
                        <div class="flex flex-col items-center mr-3 mt-0.5">
                            <button onclick="aprobarReglaManual('${paciente.id}', '${docName}', ${index})" class="hover:scale-125 transition transform text-sm bg-red-100 text-red-600 border border-red-300 rounded-full w-7 h-7 flex items-center justify-center shadow-sm cursor-pointer" title="Haz clic para aprobar manualmente">‚ùå</button>
                            <span class="text-[8px] text-red-500 font-bold uppercase mt-1 text-center">Forzar<br>Aprob.</span>
                        </div>`;
                }
                
                const li = document.createElement('li'); 
                li.className = `flex items-start p-3 rounded border ${bgClass} mb-2 transition-all`;
                li.innerHTML = `
                    ${iconHTML}
                    <div class="flex-1">
                        <span class="text-sm font-bold ${titleColor} block">${item.categoria || 'Evaluaci√≥n'}</span>
                        <span class="text-xs text-gray-700 mt-1 block">${item.comentario || ''}</span>
                    </div>
                `;
                ul.appendChild(li);
            });
                const iframe = document.getElementById('visor-pdf-iframe');
            if (statusObj.pdfUrl) { iframe.src = statusObj.pdfUrl; } 
            else if (statusObj.pdfBase64) { iframe.src = `data:application/pdf;base64,${statusObj.pdfBase64}`; } 
            else { iframe.src = ''; }
            document.getElementById('modal-checklist').classList.remove('hidden');
        }

        // ==========================================
        // L√ìGICA DE APROBACI√ìN MANUAL 
        // ==========================================
        window.aprobarReglaManual = function(idPaciente, docName, indexRegla) {
            const paciente = bdMinas[fechaActualStr].pacientes.find(p => p.id === idPaciente.toString() || p.id === idPaciente);
            if(!paciente) return;
            
            const statusObj = paciente.docsStatus[docName];
            const item = statusObj.checklist[indexRegla];
            
            if (!item.manualOverride) {
                if(!confirm("¬øEst√°s seguro de marcar este criterio como 'revisado' manualmente?")) return;
                
                item.originalPass = item.pass;
                item.originalComentario = item.comentario;
                
                item.pass = true;
                item.manualOverride = true;
                item.comentario += " [‚úîÔ∏è Aprobado por administrador]";
            } else {
                if(!confirm("¬øDeseas deshacer la revisi√≥n manual?")) return;
                
                item.pass = item.originalPass;
                item.comentario = item.originalComentario;
                item.manualOverride = false;
            }
            
            const todosAprobados = statusObj.checklist.every(i => i.pass);
            statusObj.estado = todosAprobados ? 'aprobado' : 'rechazado';
            
            if (typeof db !== 'undefined' && db !== null) {
                const docsParaGuardar = JSON.parse(JSON.stringify(paciente.docsStatus));
                Object.keys(docsParaGuardar).forEach(k => delete docsParaGuardar[k].pdfBase64);
                db.collection("PacientesMinas").doc(paciente.id.toString()).update({ docsStatus: docsParaGuardar })
                  .catch(e => console.error("Error BD:", e));
            }

            renderizarExpedientesMinas();
            abrirModalChecklistMinas(idPaciente, docName);
        };

        
        // --- FUNCI√ìN: DESCARGAR EXCEL ---
        function exportarExcelMinas() {
            if(!bdMinas[fechaActualStr] || bdMinas[fechaActualStr].pacientes.length === 0) {
                mostrarToast("No hay pacientes registrados hoy para exportar.");
                return;
            }

            // Formatear los datos para que Excel los entienda bonito
            const dataParaExcel = bdMinas[fechaActualStr].pacientes.map(p => ({
                "D√≠a Operativo": p.fechaOperativa,
                "Nombre del Paciente": p.nombre,
                "No. de Orden": p.numeroOrden,
                "Folio HC": p.folioHC,
                "Estudios Realizados": p.estudios.join(', '),
                "Estado Expediente": p.statusIntegral === 'completado' ? 'Validado y Terminado' : (p.statusIntegral === 'analizando' ? 'En An√°lisis IA' : 'Pendiente o Incompleto')
            }));

            // Usar SheetJS para generar el libro de Excel
            const hoja = XLSX.utils.json_to_sheet(dataParaExcel);
            const libro = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(libro, hoja, "Estad√≠stica MINAS");

            // Disparar la descarga autom√°tica
            XLSX.writeFile(libro, `Estadistica_MINAS_${fechaActualStr}.xlsx`);
        }
        
        function eliminarPacienteMinas(id) {
            if(!confirm("¬øEst√°s seguro de eliminar este paciente y todos sus documentos? Esta acci√≥n no se puede deshacer.")) return;
            
            // 1. Eliminar de la vista actual
            bdMinas[fechaActualStr].pacientes = bdMinas[fechaActualStr].pacientes.filter(p => p.id !== id.toString());
            renderizarExpedientesMinas();
            
            // 2. Eliminar permanentemente de la Base de Datos (Firebase)
            if (typeof db !== 'undefined' && db !== null) {
                db.collection("PacientesMinas").doc(id.toString()).delete()
                  .then(() => console.log("Paciente eliminado permanentemente."))
                  .catch(e => console.error("Error al eliminar de Firebase:", e));
            }
        }

        async function accionDocMinasIndividual(idPaciente, docName, accion) {
            const paciente = bdMinas[fechaActualStr].pacientes.find(p => p.id === idPaciente.toString() || p.id === idPaciente);
            if(!paciente) return;
            
            const statusObj = paciente.docsStatus[docName];
            
            if (accion === 'subir') {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/pdf';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(evt) {
                            statusObj.pdfBase64 = evt.target.result.split(',')[1];
                            statusObj.estado = 'subido';
                            statusObj.checklist = [];
                            paciente.statusIntegral = 'pendiente'; 
                            renderizarExpedientesMinas();

                            // Actualizamos el estado "Subido" en la base de datos
                            if (db) {
                                const docsParaGuardar = JSON.parse(JSON.stringify(paciente.docsStatus));
                                Object.keys(docsParaGuardar).forEach(k => delete docsParaGuardar[k].pdfBase64);
                                
                                db.collection("PacientesMinas").doc(paciente.id.toString()).update({
                                    docsStatus: docsParaGuardar,
                                    statusIntegral: paciente.statusIntegral
                                }).catch(e => console.error("Error al actualizar Firebase:", e));
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();

            } else if (accion === 'analizar') {
                if (!statusObj.pdfBase64) {
                    mostrarToast('Error: No se ha cargado el documento PDF correctamente. Intenta resubirlo.', 'error');
                    return;
                }

                // ==========================================
                // REGLA: ESPERAR A LA HISTORIA CL√çNICA
                // ==========================================
                const requiereHC = paciente ? paciente.estudios.includes('Historia Cl√≠nica') : false;
                if (requiereHC && (docName === 'Espirometr√≠a' || docName === 'Audiometr√≠a')) {
                    const hcStatus = paciente.docsStatus['Historia Cl√≠nica'];
                    if (!hcStatus || hcStatus.estado !== 'aprobado') {
                        const proceder = confirm(`‚ö†Ô∏è ALERTA DE SISTEMA ‚ö†Ô∏è\n\nEst√°s a punto de analizar la ${docName}, pero la Historia Cl√≠nica a√∫n no ha sido Aprobada.\n\nLa IA requiere cruzar datos con la HC. Si contin√∫as, las reglas de cruce saldr√°n rechazadas.\n\n¬øDeseas analizar de todos modos?`);
                        if (!proceder) return;
                    }
                }

                statusObj.estado = 'analizando'; 
                renderizarExpedientesMinas();
                
                // ==========================================
                // NUEVO: ENVIAR AL VISOR MINAS
                // ==========================================
                if (!statusObj.pdfUrl && statusObj.pdfBase64) {
                    mostrarToast('Preparando Visor Seguro...', 'info');
                    statusObj.pdfUrl = await guardarPDFEnStorage(statusObj.pdfBase64, paciente.id, docName);
                }

                const tipoBackend = docName === 'Historia Cl√≠nica' ? 'Historia Cl√≠nica (MINAS)' : docName;

                const datosParaIA = {
                    nombre: paciente.nombre,
                    nacimiento: paciente.fechaNacimiento,
                    orden: paciente.numeroOrden,
                    folio: paciente.folioHC,
                    datosHC: paciente.datosExtraidosHC,
                    requiereHC: requiereHC
                };

                fetch('/.netlify/functions/analizarDocumento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pdfBase64: statusObj.pdfBase64,
                        tipoDocumento: tipoBackend,
                        datosPaciente: datosParaIA
                    })
                })
                .then(response => response.text())
                .then(responseText => {
                    try {
                        const errorObj = JSON.parse(responseText);
                        if(errorObj.error) throw new Error(errorObj.error);
                        
                        const resultadoIA = JSON.parse(responseText);
                        statusObj.checklist = resultadoIA.checklist;
                        statusObj.estado = resultadoIA.aprobadoGeneral ? 'aprobado' : 'rechazado';
                        
                        if (tipoBackend === 'Historia Cl√≠nica (MINAS)' && resultadoIA.datosExtraidosHC) {
                            paciente.datosExtraidosHC = resultadoIA.datosExtraidosHC;
                        }

                        renderizarExpedientesMinas();

                        if (db) {
                            const docsParaGuardar = JSON.parse(JSON.stringify(paciente.docsStatus));
                            Object.keys(docsParaGuardar).forEach(k => delete docsParaGuardar[k].pdfBase64);

                            const updateData = { docsStatus: docsParaGuardar };
                            if (paciente.datosExtraidosHC) {
                                updateData.datosExtraidosHC = paciente.datosExtraidosHC;
                            }

                            db.collection("PacientesMinas").doc(paciente.id.toString()).update(updateData)
                              .catch(e => console.error("Error al guardar Checklist en Firebase:", e));
                        }

                    } catch(e) {
                        console.error("Error en la IA:", e);
                        statusObj.estado = 'rechazado';
                        statusObj.checklist = [{categoria: "Error Interno", pass: false, comentario: "Fall√≥ la lectura del documento. " + e.message}];
                        renderizarExpedientesMinas();
                    }
                })
                .catch(error => {
                    console.error("Error de conexi√≥n:", error);
                    statusObj.estado = 'rechazado';
                    statusObj.checklist = [{categoria: "Error de Red", pass: false, comentario: "No se pudo contactar al servidor: " + error.message}];
                    renderizarExpedientesMinas();
                });
            }
        }
        
        function abrirModalChecklistMinas(idPaciente, docName) {
            const paciente = bdMinas[fechaActualStr].pacientes.find(p => p.id === idPaciente.toString() || p.id === idPaciente);
            if(!paciente || !paciente.docsStatus[docName].checklist) return;
            
            const checklist = paciente.docsStatus[docName].checklist;
            document.getElementById('checklist-subtitulo').textContent = `${docName} - ${paciente.nombre}`;
            const ul = document.getElementById('lista-checklist'); 
            ul.innerHTML = '';
            
            checklist.forEach((item, index) => {
                let bgClass = item.pass ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                let titleColor = item.pass ? 'text-green-800' : 'text-red-800';
                
                // Si fue aprobado manualmente, cambiamos a dise√±o Azul
                if (item.manualOverride) {
                    bgClass = 'bg-blue-50 border-blue-300';
                    titleColor = 'text-blue-800';
                }

                const li = document.createElement('li'); 
                li.className = `flex items-start p-3 rounded border ${bgClass} mb-2 transition-all`;
                
                let icon = item.pass ? '‚úÖ' : '‚ùå';
                
                // Generar los botones de acci√≥n dependiendo del estado
                let extraHTML = '';
                if (item.manualOverride) {
                    extraHTML = `
                        <div class="mt-2 text-left flex items-center">
                            <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded border border-blue-300 font-bold uppercase tracking-wider">‚úîÔ∏è Cambio Manual</span> 
                            <button onclick="aprobarReglaManual('${paciente.id}', '${docName}', ${index})" class="text-[10px] text-gray-500 underline ml-3 hover:text-gray-800 font-medium">Deshacer</button>
                        </div>`;
                } else if (!item.pass) {
                    extraHTML = `
                        <div class="mt-3 text-right">
                            <button onclick="aprobarReglaManual('${paciente.id}', '${docName}', ${index})" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 px-3 py-1 rounded text-xs font-bold shadow-sm transition">
                                ‚úèÔ∏è Marcar como revisado manualmente
                            </button>
                        </div>`;
                }

                li.innerHTML = `
                    <span class="mr-3 mt-0.5 text-lg cursor-default">${icon}</span>
                    <div class="flex-1">
                        <span class="text-sm font-bold ${titleColor} block">${item.categoria || 'Evaluaci√≥n'}</span>
                        <span class="text-xs text-gray-700 mt-1 block">${item.comentario || ''}</span>
                        ${extraHTML}
                    </div>
                `;
                ul.appendChild(li);
            });
                const iframe = document.getElementById('visor-pdf-iframe');
            if (paciente.docsStatus[docName].pdfUrl) { iframe.src = paciente.docsStatus[docName].pdfUrl; } 
            else if (paciente.docsStatus[docName].pdfBase64) { iframe.src = `data:application/pdf;base64,${paciente.docsStatus[docName].pdfBase64}`; } 
            else { iframe.src = ''; }
            document.getElementById('modal-checklist').classList.remove('hidden');
        }
        
        function analizarExpedienteMinas(idPaciente) {
            const paciente = bdMinas[fechaActualStr].pacientes.find(p => p.id === idPaciente);
            if(!paciente) return;

            paciente.statusIntegral = 'analizando';
            renderizarExpedientesMinas();

            // Simular an√°lisis integral cross-document (1.5 segundos)
            setTimeout(() => {
                paciente.statusIntegral = 'completado';
                renderizarExpedientesMinas();
                
                // Mostrar alerta simulando el feedback integral
                mostrarToast(`LAP.IA: Expediente Integral de ${paciente.nombre}\n\n‚úÖ Congruencia detectada entre interrogatorio de HC y resultados de Espirometr√≠a.\n‚úÖ Identificadores y folios cruzan correctamente en los 3 documentos.\n\nEstatus: Aprobado para entrega a mina.`);
            }, 1500);
        }

        // ==============================================================================
        // RESTO DE FUNCIONES (SUCURSAL Y ADMIN TRADICIONAL)
        // ==============================================================================

        function abrirModalChecklist(docKey, tipoEstudio) {
            const sucursalTarget = obtenerTargetSucursal();
            const statusObj = bdGlobal[fechaActualStr][sucursalTarget].docsStatus[docKey];
            if (!statusObj || !statusObj.checklist) return;
            
            // Extraer el nombre del paciente real en lugar de decir "Simulaci√≥n Local"
            const idPaciente = docKey.split('-')[1]; 
            const paciente = bdGlobal[fechaActualStr][sucursalTarget].pacientes.find(p => p.id === idPaciente);
            const nombrePaciente = paciente ? paciente.nombre : 'Documento';

            document.getElementById('checklist-subtitulo').textContent = `${tipoEstudio} - ${nombrePaciente}`;
            const ul = document.getElementById('lista-checklist'); ul.innerHTML = '';
            
            statusObj.checklist.forEach((item, index) => {
                let bgClass = item.pass ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                let titleColor = item.pass ? 'text-green-800' : 'text-red-800';
                
                // Si fue aprobado manualmente, cambiamos a dise√±o Azul
                if (item.manualOverride) {
                    bgClass = 'bg-blue-50 border-blue-300';
                    titleColor = 'text-blue-800';
                }

                const li = document.createElement('li'); 
                li.className = `flex items-start p-3 rounded border ${bgClass} mb-2 transition-all`;
                
                let icon = item.pass ? '‚úÖ' : '‚ùå';
                
                // Generar los botones de acci√≥n manual igual que en MINAS
                let extraHTML = '';
                if (item.manualOverride) {
                    extraHTML = `
                        <div class="mt-2 text-left flex items-center">
                            <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded border border-blue-300 font-bold uppercase tracking-wider">‚úîÔ∏è Cambio Manual</span> 
                            <button onclick="aprobarReglaManualRed('${docKey}', '${tipoEstudio}', ${index})" class="text-[10px] text-gray-500 underline ml-3 hover:text-gray-800 font-medium">Deshacer</button>
                        </div>`;
                } else if (!item.pass) {
                    extraHTML = `
                        <div class="mt-3 text-right">
                            <button onclick="aprobarReglaManualRed('${docKey}', '${tipoEstudio}', ${index})" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 px-3 py-1 rounded text-xs font-bold shadow-sm transition">
                                ‚úèÔ∏è Marcar como revisado manualmente
                            </button>
                        </div>`;
                }

                li.innerHTML = `
                    <span class="mr-3 mt-0.5 text-lg cursor-default">${icon}</span>
                    <div class="flex-1">
                        <span class="text-sm font-bold ${titleColor} block">${item.categoria || 'Evaluaci√≥n'}</span>
                        <span class="text-xs text-gray-700 mt-1 block">${item.comentario || ''}</span>
                        ${extraHTML}
                    </div>
                `;
                ul.appendChild(li);
            });
            document.getElementById('modal-checklist').classList.remove('hidden');
        }

        // ==========================================
        // NUEVA L√ìGICA DE APROBACI√ìN MANUAL PARA LA RED DE SUCURSALES
        // ==========================================
        window.aprobarReglaManualRed = function(docKey, tipoEstudio, indexRegla) {
            const sucursalTarget = obtenerTargetSucursal();
            const statusObj = bdGlobal[fechaActualStr][sucursalTarget].docsStatus[docKey];
            const item = statusObj.checklist[indexRegla];
            
            if (!item.manualOverride) {
                if(!confirm("¬øEst√°s seguro de marcar este criterio como 'revisado' manualmente?")) return;
                
                item.originalPass = item.pass;
                item.originalComentario = item.comentario;
                
                item.pass = true;
                item.manualOverride = true;
                item.comentario += " [‚úîÔ∏è Aprobado por el supervisor]";
            } else {
                if(!confirm("¬øDeseas deshacer la revisi√≥n manual?")) return;
                
                item.pass = item.originalPass;
                item.comentario = item.originalComentario;
                item.manualOverride = false;
            }
            
            const todosAprobados = statusObj.checklist.every(i => i.pass);
            statusObj.estado = todosAprobados ? 'aprobado' : 'rechazado';
            
            // Actualizar la Base de Datos de Firebase en el paciente correcto
            const idPaciente = docKey.split('-')[1]; 
            const paciente = bdGlobal[fechaActualStr][sucursalTarget].pacientes.find(p => p.id === idPaciente);

            if (typeof db !== 'undefined' && db !== null && paciente) {
                db.collection("PacientesRed").doc(paciente.id).update({ 
                    [`docsStatus.${docKey}`]: statusObj 
                }).catch(e => console.error("Error BD:", e));
            }

            actualizarUI();
            abrirModalChecklist(docKey, tipoEstudio);
        };

        function cerrarModal(idModal) { document.getElementById(idModal).classList.add('hidden'); docKeyActivo = ''; document.getElementById('input-nota').value = ''; }

        function calcularEstadisticasSucursal(dataSucursal) {
            let req = 0, subidos = 0, aprobados = 0, estudios = 0, docKeysRequeridos = []; let countElectro = 0, countHistoria = 0, countEspiro = 0, countAudio = 0;
            if(!dataSucursal || !dataSucursal.pacientes || dataSucursal.pacientes.length === 0) return { req, subidos, aprobados, docKeysRequeridos, estudios };
            dataSucursal.pacientes.forEach(p => { estudios += p.estudios.length; p.estudios.forEach(est => {
                if (est === 'Electrocardiograma') { docKeysRequeridos.push({ key: `doc-${p.id}-Electro`, tipo: 'Electrocardiograma', nombre: p.nombre, desc: 'Trazo individual (PDF/JPG)' }); countElectro++; } 
                else if (est === 'Historia Cl√≠nica') { docKeysRequeridos.push({ key: `doc-${p.id}-Historia`, tipo: 'Historia Cl√≠nica', nombre: p.nombre, desc: 'Historia individual' }); countHistoria++; } 
                else if (est === 'Espirometr√≠a') { docKeysRequeridos.push({ key: `doc-${p.id}-Espiro`, tipo: 'Espirometr√≠a', nombre: p.nombre, desc: 'Estudio individual' }); docKeysRequeridos.push({ key: `cons-${p.id}-Espiro`, tipo: 'Consentimiento Espiro', nombre: p.nombre, desc: 'Firma requerida' }); countEspiro++; } 
                else if (est === 'Audiometr√≠a') { docKeysRequeridos.push({ key: `doc-${p.id}-Audio`, tipo: 'Audiometr√≠a', nombre: p.nombre, desc: 'Estudio individual' }); countAudio++; } 
                else if (est === 'N√≥rdico') { docKeysRequeridos.push({ key: `doc-${p.id}-Nordico`, tipo: 'Cuestionario N√≥rdico', nombre: p.nombre, desc: 'Cuestionario individual' }); } 
                else if (est === 'EXCAVIS') { docKeysRequeridos.push({ key: `doc-${p.id}-Excavis`, tipo: 'EXCAVIS', nombre: p.nombre, desc: 'Capacidad visual individual' }); } 
                else if (est === 'Timpanometr√≠a') { docKeysRequeridos.push({ key: `doc-${p.id}-Timpano`, tipo: 'Timpanometr√≠a', nombre: p.nombre, desc: 'Estudio individual' }); }
            });});
            if (countElectro > 0) docKeysRequeridos.push({ key: `acumulado-electro`, tipo: 'Cuestionarios Electros', nombre: `Acumulado General`, desc: `Concentrado de ${countElectro} cuestionarios` });
            if (countHistoria > 0) docKeysRequeridos.push({ key: `acumulado-historia`, tipo: 'Etiquetas Historias', nombre: `Acumulado General`, desc: `Concentrado de ${countHistoria} etiquetas` });
            if (countEspiro > 0) docKeysRequeridos.push({ key: `acumulado-espiro`, tipo: 'Etiquetas Espirometr√≠as', nombre: `Acumulado General`, desc: `Concentrado de ${countEspiro} etiquetas` });
            if (countAudio > 0) docKeysRequeridos.push({ key: `acumulado-audio`, tipo: 'Etiquetas Audiometr√≠as', nombre: `Acumulado General`, desc: `Concentrado de ${countAudio} etiquetas` });
            req = docKeysRequeridos.length;
            docKeysRequeridos.forEach(item => { let info = dataSucursal.docsStatus[item.key]; if (info && info.estado !== 'pendiente') { subidos++; if (info.estado === 'aprobado') aprobados++; } });
            return { req, subidos, aprobados, docKeysRequeridos, estudios };
        }
        function ordenarDocumentos(docs, tipoFiltro) { if (tipoFiltro === 'paciente') return docs.sort((a, b) => a.nombre.localeCompare(b.nombre)); else if (tipoFiltro === 'estudio') return docs.sort((a, b) => a.tipo.localeCompare(b.tipo)); return docs; }
        function actualizarEstadisticasLocales(sucursal, prefixTarget) { const data = bdGlobal[fechaActualStr]?.[sucursal]; const stats = calcularEstadisticasSucursal(data); document.getElementById(`${prefixTarget}-estudios`).textContent = stats.estudios; document.getElementById(`${prefixTarget}-carga`).textContent = `${stats.req > 0 ? Math.round((stats.subidos / stats.req) * 100) : 0}%`; document.getElementById(`${prefixTarget}-ia`).textContent = `${stats.req > 0 ? Math.round((stats.aprobados / stats.req) * 100) : 0}%`; }

        function obtenerTargetSucursal() { return rolActual === 'admin' ? sucursalAuditada : sucursalActual; }
        function asegurarEstructuraDoc(docKey) { const data = bdGlobal[fechaActualStr][obtenerTargetSucursal()]; if (!data.docsStatus[docKey]) data.docsStatus[docKey] = { estado: 'pendiente', notas: [], horaSubida: null, vistosAdmin: 0, vistosSucursal: 0, checklist: [] }; return data.docsStatus[docKey]; }
        function abrirModalNotas(docKey, titulo) { docKeyActivo = docKey; const statusObj = asegurarEstructuraDoc(docKey); if (rolActual === 'admin') statusObj.vistosAdmin = statusObj.notas.length; else statusObj.vistosSucursal = statusObj.notas.length; document.getElementById('modal-titulo').textContent = `Chat: ${titulo}`; document.getElementById('modal-notas').classList.remove('hidden'); renderizarChat(); actualizarUI(); }
        function renderizarChat() { const chat = document.getElementById('modal-chat'); chat.innerHTML = ''; const statusObj = asegurarEstructuraDoc(docKeyActivo); if(statusObj.notas.length === 0) { chat.innerHTML = '<p class="text-center text-gray-400 text-sm mt-4 italic">No hay comentarios.</p>'; return; } statusObj.notas.forEach(nota => { const div = document.createElement('div'); let colorBg = 'bg-white'; let textColor = 'text-gray-800'; let align = 'justify-start'; let tagColor = 'bg-gray-200 text-gray-700'; if (nota.autor === 'LAP.IA') { colorBg = 'bg-red-50 border border-red-200'; tagColor = 'bg-red-500 text-white'; textColor = 'text-red-800'; } else if (nota.autor === 'Administrador') { colorBg = 'bg-blue-50'; tagColor = 'bg-blue-500 text-white'; align = 'justify-end'; } else { colorBg = 'bg-orange-50'; tagColor = 'bg-lapiOrange text-white'; align = 'justify-end'; } div.className = `flex ${align} mb-2 w-full`; div.innerHTML = `<div class="${colorBg} p-2.5 rounded-lg shadow-sm max-w-[85%]"><div class="flex items-center space-x-2 mb-1"><span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${tagColor}">${nota.autor}</span></div><p class="text-sm ${textColor}">${nota.texto}</p></div>`; chat.appendChild(div); }); chat.scrollTop = chat.scrollHeight; }
        function agregarNota() { const input = document.getElementById('input-nota'); const texto = input.value.trim(); if(texto === '') return; const statusObj = asegurarEstructuraDoc(docKeyActivo); statusObj.notas.push({ autor: rolActual === 'admin' ? 'Administrador' : sucursalActual, texto: texto }); if (rolActual === 'admin') statusObj.vistosAdmin = statusObj.notas.length; else statusObj.vistosSucursal = statusObj.notas.length; input.value = ''; renderizarChat(); actualizarUI(); }
        function crearBotonChat(docKey, titulo, statusObj) { if (statusObj.estado === 'pendiente') return ''; let noLeidos = rolActual === 'admin' ? statusObj.notas.length - statusObj.vistosAdmin : statusObj.notas.length - statusObj.vistosSucursal; let indicador = noLeidos > 0 ? `<span class="absolute -top-1 -right-1 flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500 border border-white"></span></span>` : (statusObj.notas.length > 0 ? `<span class="absolute -top-1 -right-1 flex h-3 w-3"><span class="relative inline-flex rounded-full h-3 w-3 bg-gray-400 border border-white"></span></span>` : ''); return `<button onclick="abrirModalNotas('${docKey}', '${titulo}')" class="relative bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-lg transition ml-2 shadow-sm" title="Comentarios">üí¨ ${indicador}</button>`; }
        function simularDescarga(tipo) { mostrarToast(`Sistema LAP.IA: preparando descarga de ${tipo === 'subidos' ? "archivos subidos" : "archivos aprobados por IA"}.`); }

        function generarDirectorioUI() { const grid = document.getElementById('grid-directorio'); grid.innerHTML = ''; SUCURSALES.forEach(sucursal => { const card = document.createElement('button'); card.onclick = () => { sucursalAuditada = sucursal; mostrarVista('vista-admin-detalle'); }; card.className = "bg-gray-50 hover:bg-lapiLight border border-gray-200 p-4 rounded-lg text-left transition flex items-center shadow-sm"; card.innerHTML = `<div class="bg-gray-200 text-gray-500 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 text-sm">${sucursal.charAt(0)}</div> <span class="font-bold text-gray-700">${sucursal}</span>`; grid.appendChild(card); }); }
        function actualizarDashboardAdmin() { 
            const tbody = document.getElementById('tabla-admin-body'); 
            tbody.innerHTML = ''; 
            let granTotal = 0; let granReq = 0; let granSub = 0; let granAprob = 0; 
            
            SUCURSALES.forEach(suc => { 
                const stats = calcularEstadisticasSucursal(bdGlobal[fechaActualStr]?.[suc]); 
                if (stats.estudios > 0) { 
                    granTotal += stats.estudios; 
                    granReq += stats.req; 
                    granSub += stats.subidos; 
                    granAprob += stats.aprobados; 
                    
                    const tr = document.createElement('tr'); 
                    tr.className = 'border-b hover:bg-gray-50 transition'; 
                    tr.innerHTML = `
                        <td class="p-4 font-bold text-gray-700">${suc}</td>
                        <td class="p-4 text-center font-medium">${stats.estudios}</td>
                        <td class="p-4">
                            <div class="flex items-center space-x-2">
                                <div class="bg-gray-200 rounded-full h-2 w-full">
                                    <div class="bg-gray-600 h-2 rounded-full animate-fill-bar" style="width: ${stats.req > 0 ? Math.round((stats.subidos/stats.req)*100) : 0}%"></div>
                                </div>
                                <span class="text-xs font-bold w-8">${stats.req > 0 ? Math.round((stats.subidos/stats.req)*100) : 0}%</span>
                            </div>
                        </td>
                        <td class="p-4">
                            <div class="flex items-center space-x-2">
                                <div class="bg-orange-100 rounded-full h-2 w-full">
                                    <div class="bg-lapiOrange h-2 rounded-full animate-fill-bar" style="width: ${stats.req > 0 ? Math.round((stats.aprobados/stats.req)*100) : 0}%"></div>
                                </div>
                                <span class="text-xs font-bold text-lapiOrange w-8">${stats.req > 0 ? Math.round((stats.aprobados/stats.req)*100) : 0}%</span>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            <button onclick="sucursalAuditada='${suc}'; mostrarVista('vista-admin-detalle')" class="text-blue-600 hover:text-blue-800 underline font-bold text-sm bg-blue-50 px-3 py-1 rounded">Auditar ‚ûî</button>
                        </td>
                    `; 
                    tbody.appendChild(tr); 
                } 
            }); 
            
            if(granTotal === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-gray-500 italic">No hay registros hoy.</td></tr>'; 
            }
            
            document.getElementById('admin-totales').textContent = granTotal; 
            document.getElementById('admin-carga').textContent = `${granReq>0 ? Math.round((granSub/granReq)*100) : 0}%`; 
            document.getElementById('admin-ia').textContent = `${granReq>0 ? Math.round((granAprob/granReq)*100) : 0}%`; 
        } 
        function eliminarPaciente(id) { bdGlobal[fechaActualStr][sucursalActual].pacientes = bdGlobal[fechaActualStr][sucursalActual].pacientes.filter(p => p.id !== id); actualizarUI(); }
        function actualizarListaPacientes() { 
            const ul = document.getElementById('listaPacientes'); 
            ul.innerHTML = ''; 
            if (!sucursalActual || !bdGlobal[fechaActualStr] || !bdGlobal[fechaActualStr][sucursalActual]) return;
            
            const pacs = bdGlobal[fechaActualStr][sucursalActual].pacientes; 
            document.getElementById('contador-pacientes').textContent = pacs.length; 
            
            pacs.forEach(p => { 
                const li = document.createElement('li'); 
                li.className = 'bg-gray-50 p-3 rounded flex justify-between items-center border border-gray-100 hover:bg-gray-100 transition'; 
                
                const btnEditar = `<button onclick="abrirModalEditarRed('${p.id}')" class="text-blue-500 hover:text-blue-700 text-xs font-bold border border-blue-200 bg-white px-2 py-1 rounded shadow-sm mr-2">‚úèÔ∏è Editar</button>`;
                const btnEliminar = `<button onclick="eliminarPaciente('${p.id}')" class="text-red-500 hover:text-red-700 text-xs font-bold border border-red-200 bg-white px-2 py-1 rounded shadow-sm">‚úï Eliminar</button>`;
                
                li.innerHTML = `
                    <div>
                        <strong class="text-gray-800 text-sm block">${p.nombre}</strong>
                        <span class="text-xs text-gray-500 font-medium mt-1 block">${p.estudios.join(', ')}</span>
                    </div>
                    <div class="flex items-center">
                        ${btnEditar}
                        ${btnEliminar}
                    </div>
                `; 
                ul.appendChild(li); 
            }); 
        }    
        function generarCajasDeCarga() { 
            const contenedor = document.getElementById('contenedorArchivos'); 
            contenedor.innerHTML = ''; 
            
            if (!sucursalActual || !bdGlobal[fechaActualStr] || !bdGlobal[fechaActualStr][sucursalActual]) return;
            
            const stats = calcularEstadisticasSucursal(bdGlobal[fechaActualStr][sucursalActual]); 
            
            // ESTADO VAC√çO: Cuando el recepcionista a√∫n no registra pacientes en la pesta√±a anterior
            if (stats.req === 0) { 
                contenedor.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-gray-400 fade-in border-2 border-dashed border-gray-200 rounded-lg mt-4">
                        <span class="text-6xl mb-4 opacity-50 grayscale">üìù</span>
                        <p class="text-lg font-bold text-gray-500">Todo en orden</p>
                        <p class="text-sm mt-1">Ve a la pesta√±a "Registro Diario" para dar de alta pacientes primero.</p>
                    </div>`; 
                return; 
            } 
            
            const documentosOrdenados = ordenarDocumentos(stats.docKeysRequeridos, document.getElementById('filtro-sucursal').value); 
            
            documentosOrdenados.forEach(item => { 
                renderizarCajaDocumento(item, contenedor, true); 
            }); 
        }

        function renderizarCajaDocumento(item, contenedor, interactivo) {
            const statusObj = asegurarEstructuraDoc(item.key); const esAcumulado = item.key.startsWith('acumulado-'); const box = document.createElement('div'); box.className = `${esAcumulado ? 'border-lapiOrange border-2 bg-lapiLight' : 'border-gray-200 border bg-white'} p-4 rounded-lg flex flex-col md:flex-row justify-between items-center shadow-sm mb-3`;
            let btnUI = ''; let btnChecklist = (statusObj.estado === 'aprobado' || statusObj.estado === 'rechazado') ? `<button onclick="abrirModalChecklist('${item.key}', '${item.tipo}')" class="text-[10px] text-blue-500 hover:underline font-bold ml-2">üìã Detalles</button>` : '';
            if (interactivo) {
                if (statusObj.estado === 'pendiente') btnUI = `<button onclick="accionDocumento('${item.key}', 'subir', '${item.tipo}')" class="bg-gray-200 hover:bg-gray-300 text-sm font-bold py-1.5 px-4 rounded transition border border-gray-300">Subir Archivo</button>`;
                else if (statusObj.estado === 'subido') btnUI = `<div class="flex items-center"><span class="text-xs text-gray-500 mr-2 font-bold">‚úì Subido</span> <button onclick="accionDocumento('${item.key}', 'analizar', '${item.tipo}')" class="bg-gray-800 text-white hover:bg-gray-900 text-sm font-bold py-1.5 px-3 rounded shadow-md transition">‚ú® Analizar IA</button></div>`;
                else if (statusObj.estado === 'analizando') btnUI = `<span class="text-lapiOrange text-sm font-bold animate-pulse">üß† Analizando...</span>`;
                else if (statusObj.estado === 'aprobado') btnUI = `<span class="bg-green-100 text-green-700 border border-green-300 px-3 py-1 rounded text-sm font-bold flex items-center">‚úÖ Aprobado ${btnChecklist}</span>`;
                else if (statusObj.estado === 'rechazado') btnUI = `<div class="flex items-center"><span class="bg-red-100 text-red-700 border border-red-300 px-2 py-1 rounded text-xs font-bold mr-2 flex items-center">‚ùå Rechazado IA ${btnChecklist}</span> <button onclick="accionDocumento('${item.key}', 'subir', '${item.tipo}')" class="text-xs underline text-gray-500 hover:text-gray-700">Resubir</button></div>`;
            } else {
                if (statusObj.estado === 'pendiente') btnUI = '<span class="text-gray-400 font-bold text-xs flex items-center">‚ö†Ô∏è Faltante</span>';
                else if (statusObj.estado === 'subido') btnUI = '<span class="text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-200 font-bold text-xs">üìÅ Subido</span>';
                else if (statusObj.estado === 'aprobado') btnUI = `<span class="text-green-700 bg-green-100 px-2 py-1 rounded border border-green-300 font-bold text-xs flex items-center">‚úÖ Aprobado IA ${btnChecklist}</span>`;
                else if (statusObj.estado === 'rechazado') btnUI = `<span class="text-red-700 bg-red-100 px-2 py-1 rounded border border-red-300 font-bold text-xs flex items-center">‚ùå Rechazado IA ${btnChecklist}</span>`;
                else if (statusObj.estado === 'analizando') btnUI = '<span class="text-lapiOrange font-bold text-xs">üß† Analizando...</span>';
            }
            const infoExtra = statusObj.horaSubida ? `<span class="text-lapiOrange ml-2 text-[10px] font-bold">Subido: ${statusObj.horaSubida}</span>` : ''; const btnChat = crearBotonChat(item.key, item.tipo, statusObj);
            box.innerHTML = `<div class="flex-1 w-full"><div class="flex items-center justify-between w-full"><div><h4 class="text-sm font-bold">${item.tipo} <span class="text-lapiOrange ml-1">${item.nombre}</span></h4><p class="text-xs text-gray-400 mt-0.5">${item.desc} ${infoExtra}</p></div><div class="ml-4 flex items-center">${btnUI} ${btnChat}</div></div></div>`; contenedor.appendChild(box);
        }

        
        // --- 1. CARGAR DATOS DE SUCURSALES DESDE FIREBASE ---
        async function cargarPacientesRedDesdeFirebase() {
            if (!db) return;
            mostrarCarga('Descargando expedientes MINAS...'); // <--- AQUI ACTIVA
            try {
                const snapshot = await db.collection("PacientesRed").where("fechaOperativa", "==", fechaActualStr).get();
                // Limpiamos memoria del d√≠a
                if (!bdGlobal[fechaActualStr]) bdGlobal[fechaActualStr] = {};
                SUCURSALES.forEach(suc => bdGlobal[fechaActualStr][suc] = { pacientes: [], docsStatus: {} });
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(bdGlobal[fechaActualStr][data.sucursal]) {
                        bdGlobal[fechaActualStr][data.sucursal].pacientes.push(data);
                        if (data.docsStatus) Object.assign(bdGlobal[fechaActualStr][data.sucursal].docsStatus, data.docsStatus);
                    }
                });
                actualizarUI();
            } catch (error) { console.error("Error BD Red:", error); }
        finally { ocultarCarga();
        }

        // --- 3. NUEVO REGISTRO DE PACIENTE EST√ÅNDAR ---
        function agregarPaciente() { 
            const nombre = document.getElementById('nombrePaciente').value.trim();
            const nacimiento = document.getElementById('nacimientoPaciente').value;
            const orden = document.getElementById('ordenPaciente').value.trim();
            const folio = document.getElementById('folioPaciente').value.trim();
            const cbs = document.querySelectorAll('.estudio-cb:checked'); 
            
            if (!nombre || !nacimiento || (!orden && !folio) || cbs.length === 0) { 
                mostrarToast('Faltan datos. Llena Nombre, Fecha, al menos un identificador (Orden o Folio) y selecciona estudios.'); 
                return; 
            } 
            
            const duplicado = bdGlobal[fechaActualStr][sucursalActual].pacientes.some(p => 
                (orden !== '' && p.numeroOrden === orden) || 
                (folio !== '' && p.folioHC === folio)
            );
            if (duplicado) { mostrarToast('‚ö†Ô∏è ERROR: Ya existe un paciente con este Orden o Folio hoy.'); return; }

            const nuevoPaciente = {
                id: Date.now().toString(), sucursal: sucursalActual, fechaOperativa: fechaActualStr,
                nombre, fechaNacimiento: nacimiento, numeroOrden: orden, folioHC: folio,
                estudios: Array.from(cbs).map(cb => cb.value), datosExtraidosHC: null, docsStatus: {}
            };

            bdGlobal[fechaActualStr][sucursalActual].pacientes.push(nuevoPaciente);
            if (db) db.collection("PacientesRed").doc(nuevoPaciente.id).set(nuevoPaciente).catch(e => console.error(e));

            document.getElementById('nombrePaciente').value = ''; document.getElementById('nacimientoPaciente').value = '';
            document.getElementById('ordenPaciente').value = ''; document.getElementById('folioPaciente').value = '';
            cbs.forEach(cb => cb.checked = false); actualizarUI(); 
        }

        // --- 4. B√öSQUEDA EN PANEL DE RED ---
        function generarVistaDetalleAdmin() { 
            document.getElementById('detalle-titulo').innerHTML = `<span class="text-lapiOrange">Auditor√≠a:</span> ${sucursalAuditada}`; 
            actualizarEstadisticasLocales(sucursalAuditada, 'audit'); 
            const contenedor = document.getElementById('contenedorDetalleAdmin'); 
            contenedor.innerHTML = ''; 
            
            const stats = calcularEstadisticasSucursal(bdGlobal[fechaActualStr]?.[sucursalAuditada]); 
            
            // ESTADO VAC√çO 1: Cuando la sucursal no ha registrado a nadie hoy
            if (stats.req === 0) { 
                contenedor.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-gray-400 fade-in border-2 border-dashed border-gray-200 rounded-lg mt-4">
                        <span class="text-6xl mb-4 opacity-50 grayscale">üì≠</span>
                        <p class="text-lg font-bold text-gray-500">Sin registros de red</p>
                        <p class="text-sm mt-1">Esta sucursal a√∫n no ha registrado estudios el d√≠a de hoy.</p>
                    </div>`; 
                return; 
            } 
            
            let documentosOrdenados = ordenarDocumentos(stats.docKeysRequeridos, document.getElementById('filtro-admin').value); 
            
            // Aplicar B√∫squeda por Nombre, Folio u Orden
            const termino = (document.getElementById('buscadorRed')?.value || '').toLowerCase();
            if (termino !== '') {
                const pacientes = bdGlobal[fechaActualStr]?.[sucursalAuditada]?.pacientes || [];
                const idsCoincidentes = pacientes.filter(p => 
                    p.nombre.toLowerCase().includes(termino) || 
                    p.numeroOrden.toLowerCase().includes(termino) || 
                    p.folioHC.toLowerCase().includes(termino)
                ).map(p => p.id);
                
                documentosOrdenados = documentosOrdenados.filter(doc => idsCoincidentes.some(id => doc.key.includes(`-${id}-`)));
            }

            // ESTADO VAC√çO 2: Cuando la b√∫squeda no encuentra nada
            if (documentosOrdenados.length === 0) { 
                contenedor.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-gray-400 fade-in">
                        <span class="text-6xl mb-4 opacity-50 grayscale">üîç</span>
                        <p class="text-lg font-bold text-gray-500">B√∫squeda sin resultados</p>
                        <p class="text-sm mt-1">No se encontraron expedientes con ese nombre o folio.</p>
                    </div>`; 
                return; 
            }
            
            documentosOrdenados.forEach(item => { 
                renderizarCajaDocumento(item, contenedor, false); 
            }); 
        }

        // --- 5. LLAMADA REAL A LA IA PARA SUCURSALES ---
        async function accionDocumento(docKey, accion, tipoEstudio) {
            const statusObj = asegurarEstructuraDoc(docKey);
            const idPaciente = docKey.split('-')[1]; 
            const paciente = idPaciente && bdGlobal[fechaActualStr][obtenerTargetSucursal()].pacientes ? bdGlobal[fechaActualStr][obtenerTargetSucursal()].pacientes.find(p => p.id === idPaciente) : null;

            if (accion === 'subir') { 
                const input = document.createElement('input');
                input.type = 'file'; input.accept = 'application/pdf';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(evt) {
                            statusObj.pdfBase64 = evt.target.result.split(',')[1];
                            statusObj.estado = 'subido'; statusObj.horaSubida = new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }); 
                            statusObj.notas = []; statusObj.checklist = []; actualizarUI();
                            
                            if (db && paciente) {
                                db.collection("PacientesRed").doc(paciente.id).update({ [`docsStatus.${docKey}`]: { estado: statusObj.estado, horaSubida: statusObj.horaSubida, checklist: [] } }).catch(e=>console.log(e));
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            } 
            else if (accion === 'analizar') {
                if (!statusObj.pdfBase64) { mostrarToast('‚ö†Ô∏è PDF no encontrado en memoria. Por favor resube el archivo.'); return; }
                
                // SABER SI ESTE PACIENTE LLEVA HISTORIA CL√çNICA CONTRATADA
                const requiereHC = paciente ? paciente.estudios.includes('Historia Cl√≠nica') : false;

                // ALERTA INTELIGENTE S√ìLO SI REQUIERE HC Y A√öN NO LA HA APROBADO
                if (paciente && requiereHC && (tipoEstudio === 'Espirometr√≠a' || tipoEstudio === 'Audiometr√≠a' || tipoEstudio === 'Electrocardiograma')) {
                    const hcStatus = paciente.docsStatus[`doc-${paciente.id}-Historia`];
                    if (!hcStatus || hcStatus.estado !== 'aprobado') {
                        const proceder = confirm(`‚ö†Ô∏è ALERTA DE SISTEMA ‚ö†Ô∏è\n\nEste paciente S√ç tiene contratada una Historia Cl√≠nica, pero a√∫n no ha sido aprobada.\n\nLa IA requiere cruzar datos con la HC. Si contin√∫as, las reglas de cruce saldr√°n rechazadas temporalmente.\n\n¬øDeseas analizar de todos modos?`);
                        if (!proceder) return;
                    }
                }

                statusObj.estado = 'analizando'; actualizarUI();
                
                // ==========================================
                // NUEVO: ENVIAR AL VISOR MIENTRAS LA IA PIENSA
                // ==========================================
                if (!statusObj.pdfUrl && statusObj.pdfBase64) {
                    mostrarToast('Preparando Visor Seguro...', 'info');
                    statusObj.pdfUrl = await guardarPDFEnStorage(statusObj.pdfBase64, paciente ? paciente.id : 'temp', tipoEstudio);
                }

                const datosParaIA = paciente ? {
                    nombre: paciente.nombre, nacimiento: paciente.fechaNacimiento, orden: paciente.numeroOrden, folio: paciente.folioHC, datosHC: paciente.datosExtraidosHC,
                    requiereHC: requiereHC // <-- Le avisamos a la IA si debe ser estricta o no
                } : {};

                fetch('/.netlify/functions/analizarDocumento', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ pdfBase64: statusObj.pdfBase64, tipoDocumento: tipoEstudio, datosPaciente: datosParaIA })
                })
                .then(res => res.text())
                .then(txt => {
                    try {
                        const result = JSON.parse(txt);
                        statusObj.checklist = result.checklist;
                        statusObj.estado = result.aprobadoGeneral ? 'aprobado' : 'rechazado';
                        if (!result.aprobadoGeneral) statusObj.notas.push({ autor: 'LAP.IA', texto: `Falla cr√≠tica: ${result.motivoPrincipal || 'Revisar checklist'}` });
                        
                        if (tipoEstudio === 'Historia Cl√≠nica' && result.datosExtraidosHC && paciente) { paciente.datosExtraidosHC = result.datosExtraidosHC; }
                        actualizarUI();

                        if (db && paciente) {
                            const updateData = { [`docsStatus.${docKey}`]: { estado: statusObj.estado, horaSubida: statusObj.horaSubida, checklist: statusObj.checklist, notas: statusObj.notas } };
                            if (paciente.datosExtraidosHC) updateData.datosExtraidosHC = paciente.datosExtraidosHC;
                            db.collection("PacientesRed").doc(paciente.id).update(updateData);
                        }
                    } catch(e) { statusObj.estado = 'rechazado'; statusObj.checklist = [{categoria: "Error Interno", pass: false, comentario: "Fall√≥ la lectura."}]; actualizarUI(); }
                })
                .catch(err => { statusObj.estado = 'rechazado'; statusObj.checklist = [{categoria: "Error de Red", pass: false, comentario: err.message}]; actualizarUI(); });
            }
        }

        // ==========================================
        // 1. EDICI√ìN DE PACIENTES
        // ==========================================
        function abrirModalEditarMinas(id) {
            const p = bdMinas[fechaActualStr].pacientes.find(x => x.id === id);
            if(!p) return;
            document.getElementById('edit-id-paciente').value = p.id;
            document.getElementById('edit-nombre').value = p.nombre;
            document.getElementById('edit-nacimiento').value = p.fechaNacimiento || '';
            document.getElementById('edit-orden').value = p.numeroOrden || '';
            document.getElementById('edit-folio').value = p.folioHC || '';
            
            document.querySelectorAll('.edit-cb-estudio').forEach(cb => {
                cb.checked = p.estudios.includes(cb.value);
            });
            document.getElementById('modal-editar-paciente').classList.remove('hidden');
        }

        function obtenerSufijoEstudio(tipo) {
            if (tipo === 'Historia Cl√≠nica') return 'Historia';
            if (tipo === 'Espirometr√≠a') return 'Espiro';
            if (tipo === 'Audiometr√≠a') return 'Audio';
            if (tipo === 'Electrocardiograma') return 'Electro';
            if (tipo === 'N√≥rdico' || tipo === 'Cuest. N√≥rdico') return 'Nordico';
            if (tipo === 'EXCAVIS') return 'Excavis';
            if (tipo === 'Timpanometr√≠a') return 'Timpano';
            return tipo.split(' ')[0];
        }

        function guardarEdicionPacienteRed() {
            const id = document.getElementById('edit-id-paciente').value;
            const p = bdMinas[fechaActualStr].pacientes.find(x => x.id === id);
            if(!p) return;

            p.nombre = document.getElementById('edit-nombre').value.trim();
            p.fechaNacimiento = document.getElementById('edit-nacimiento').value;
            p.numeroOrden = document.getElementById('edit-orden').value.trim();
            p.folioHC = document.getElementById('edit-folio').value.trim();

            const cbs = document.querySelectorAll('.edit-cb-estudio:checked');
            const nuevosEstudios = Array.from(cbs).map(cb => cb.value);
            
            // Eliminar estudios desmarcados
            p.estudios.forEach(est => {
                if (!nuevosEstudios.includes(est)) delete p.docsStatus[est];
            });

            // Agregar estudios nuevos sin borrar el progreso de los que ya exist√≠an
            nuevosEstudios.forEach(est => {
                if (!p.docsStatus[est]) p.docsStatus[est] = { estado: 'pendiente' };
            });
            p.estudios = nuevosEstudios;

            document.getElementById('modal-editar-paciente').classList.add('hidden');
            renderizarExpedientesMinas();

            if (db) db.collection("PacientesMinas").doc(p.id).set(p).catch(e => console.log(e));
        }

        // ==========================================
        // EXTRACCI√ìN MASIVA BLINDADA (DRAG & DROP)
        // ==========================================
        async function procesarLoteArchivosMinas(files) {
            if (!files || files.length === 0) return;
            if (files.length > 5) { mostrarToast("Para evitar saturar el sistema, arrastra m√°ximo 5 archivos a la vez."); return; }

            const overlay = document.getElementById('overlay-carga-lote');
            const textoEstado = document.getElementById('texto-estado-lote');
            
            if(overlay) overlay.classList.remove('hidden');

            for (let i = 0; i < files.length; i++) {
                if(textoEstado) textoEstado.textContent = `Extrayendo datos del archivo ${i + 1} de ${files.length}...`;
                console.log(`\n--- INICIANDO ARCHIVO ${i+1}: ${files[i].name} ---`);
                
                try {
                    const base64 = await convertirArchivoABase64(files[i]);
                    console.log("Paso 1: Archivo convertido a Base64 con √©xito.");
                    
                    const req = await fetch('/.netlify/functions/analizarDocumento', {
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ pdfBase64: base64, tipoDocumento: 'Extraccion' })
                    });
                    console.log("Paso 2: Respuesta de Netlify recibida. Status:", req.status);
                    
                    if (!req.ok) {
                        throw new Error(`El servidor devolvi√≥ un error ${req.status}. (Posible Timeout de 10 segundos).`);
                    }
                    
                    const txt = await req.text();
                    console.log("Paso 3: Texto crudo recibido de Gemini:", txt);
                    
                    const resJSON = JSON.parse(txt);
                    console.log("Paso 4: JSON interpretado correctamente:", resJSON);
                    
                    // L√≥gica de Asignaci√≥n Inteligente
                    asignarDocumentoAPacienteSeguro(resJSON, base64);
                    console.log("Paso 5: Paciente asignado y creado en pantalla.");

                } catch (e) { 
                    console.error(`‚ùå Error cr√≠tico en archivo ${i + 1}:`, e);
                    mostrarToast(`Ocurri√≥ un problema con el archivo: ${files[i].name}\n\nMotivo: ${e.message}\n\nPor favor, revisa la consola (F12) para m√°s detalles.`);
                }
            }
            
            if(overlay) overlay.classList.add('hidden');
            const inputLote = document.getElementById('file-upload-lote');
            if(inputLote) inputLote.value = ""; 
            renderizarExpedientesMinas();
        }

        function asignarDocumentoAPacienteSeguro(datosExtraidos, base64) {
            const tipoDocumento = datosExtraidos.tipoDocumento || 'Documento Desconocido';
            const nombre = datosExtraidos.nombre || 'Paciente Sin Nombre';
            const fechaNacimiento = datosExtraidos.fechaNacimiento || '';
            let orden = datosExtraidos.orden || '';
            let folio = datosExtraidos.folio || '';
            
            // FILTRO ESTRICTO DE IDENTIFICADORES (IA)
            if (tipoDocumento.includes('Historia')) {
                orden = ''; // Si es HC, bloqueamos y borramos la orden
            } else {
                folio = ''; // Si NO es HC, bloqueamos y borramos el folio
            }

            let pacienteExistente = bdMinas[fechaActualStr].pacientes.find(p => {
                const coincideOrden = orden && p.numeroOrden === orden;
                const coincideFolio = folio && p.folioHC === folio;
                const primerNombreExtraido = nombre !== 'Paciente Sin Nombre' ? nombre.toLowerCase().split(' ')[0] : null;
                const coincideNombre = p.nombre && primerNombreExtraido && p.nombre.toLowerCase().includes(primerNombreExtraido);
                return coincideOrden || coincideFolio || coincideNombre;
            });

            if (pacienteExistente) {
                if (!pacienteExistente.estudios.includes(tipoDocumento)) {
                    pacienteExistente.estudios.push(tipoDocumento);
                    pacienteExistente.docsStatus[tipoDocumento] = { estado: 'subido', pdfBase64: base64, checklist: [] };
                } else {
                    const obj = pacienteExistente.docsStatus[tipoDocumento];
                    if (obj.estado === 'pendiente' || confirm(`El paciente ${pacienteExistente.nombre} ya tiene asignado(a) un(a) ${tipoDocumento}. ¬øDeseas reemplazar el archivo cargado?`)) {
                        pacienteExistente.docsStatus[tipoDocumento] = { estado: 'subido', pdfBase64: base64, checklist: [] };
                        pacienteExistente.statusIntegral = 'pendiente';
                    }
                }
                
                if (!pacienteExistente.fechaNacimiento && fechaNacimiento) pacienteExistente.fechaNacimiento = fechaNacimiento;
                if (!pacienteExistente.numeroOrden && orden) pacienteExistente.numeroOrden = orden;
                if (!pacienteExistente.folioHC && folio) pacienteExistente.folioHC = folio;

                if (db) db.collection("PacientesMinas").doc(pacienteExistente.id).set(pacienteExistente).catch(e => console.error(e));
            } else {
                let docsDelPaciente = {};
                docsDelPaciente[tipoDocumento] = { estado: 'subido', pdfBase64: base64, checklist: [] };
                
                const nuevoPaciente = { 
                    id: Date.now().toString() + Math.floor(Math.random()*100), fechaOperativa: fechaActualStr, 
                    nombre: nombre, fechaNacimiento: fechaNacimiento, numeroOrden: orden, folioHC: folio,
                    estudios: [tipoDocumento], docsStatus: docsDelPaciente, statusIntegral: 'pendiente', datosExtraidosHC: null
                };

                bdMinas[fechaActualStr].pacientes.push(nuevoPaciente);
                if(db) db.collection("PacientesMinas").doc(nuevoPaciente.id).set(nuevoPaciente).catch(e => console.error(e));
            }
        }

        // Helper
        function convertirArchivoABase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        // ==========================================
        // 3. EDICI√ìN Y EXTRACCI√ìN MASIVA PARA RED (SUCURSALES)
        // ==========================================
        // ==============================================================================
        // SISTEMA DE NOTIFICACIONES TOAST (Reemplazo de Alerts)
        // ==============================================================================
        function mostrarToast(mensaje, tipo = 'info') {
            const container = document.getElementById('toast-container');
            if(!container) return;
            
            const toast = document.createElement('div');
            let bg = 'bg-gray-800'; let icon = '‚ÑπÔ∏è';
            
            if (tipo === 'exito') { bg = 'bg-green-600'; icon = '‚úÖ'; }
            if (tipo === 'error') { bg = 'bg-red-500'; icon = '‚ùå'; }
            if (tipo === 'advertencia') { bg = 'bg-yellow-500'; icon = '‚ö†Ô∏è'; }

            toast.className = `${bg} text-white px-4 py-3 rounded-lg shadow-xl flex items-start space-x-3 text-sm font-bold transition-all duration-300 transform translate-x-full opacity-0 max-w-sm pointer-events-auto border border-white/20`;
            toast.innerHTML = `<span class="text-lg leading-none mt-0.5">${icon}</span> <span class="flex-1">${mensaje}</span>`;
            
            container.appendChild(toast);
            
            // Animar entrada suave
            setTimeout(() => { toast.classList.remove('translate-x-full', 'opacity-0'); }, 10);
            
            // Desaparecer autom√°ticamente a los 4 segundos
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // ==============================================================================
        // PREVENCI√ìN DE P√âRDIDA DE DATOS (Cierre de pesta√±a)
        // ==============================================================================
        window.addEventListener('beforeunload', function (e) {
            let hayPendientes = false;
            
            // Revisamos en MINAS si hay alg√∫n documento en estado "subido"
            if (bdMinas[fechaActualStr] && bdMinas[fechaActualStr].pacientes) {
                bdMinas[fechaActualStr].pacientes.forEach(p => {
                    Object.values(p.docsStatus).forEach(doc => { if (doc.estado === 'subido') hayPendientes = true; });
                });
            }
            
            // Revisamos en Sucursales si hay alg√∫n documento en estado "subido"
            if (bdGlobal[fechaActualStr] && sucursalActual && bdGlobal[fechaActualStr][sucursalActual] && bdGlobal[fechaActualStr][sucursalActual].pacientes) {
                bdGlobal[fechaActualStr][sucursalActual].pacientes.forEach(p => {
                    Object.values(p.docsStatus).forEach(doc => { if (doc.estado === 'subido') hayPendientes = true; });
                });
            }

            // Si detecta documentos sin analizar, lanza la advertencia nativa del navegador
            if (hayPendientes) {
                e.preventDefault();
                e.returnValue = 'Tienes documentos en memoria que a√∫n no han sido analizados por la IA. Si sales, tendr√°s que volver a arrastrarlos. ¬øDeseas salir?';
            }
        });


        function mostrarCarga(mensaje = 'Sincronizando...') {
            document.getElementById('texto-indicador-carga').textContent = mensaje;
            document.getElementById('indicador-carga').classList.remove('hidden');
        }
        function ocultarCarga() {
            document.getElementById('indicador-carga').classList.add('hidden');
        }
            
        function abrirModalEditarRed(id) {
            const p = bdGlobal[fechaActualStr][sucursalActual].pacientes.find(x => x.id === id);
            if(!p) return;
            document.getElementById('edit-id-paciente-red').value = p.id;
            document.getElementById('edit-nombre-red').value = p.nombre;
            document.getElementById('edit-nacimiento-red').value = p.fechaNacimiento || '';
            document.getElementById('edit-orden-red').value = p.numeroOrden || '';
            document.getElementById('edit-folio-red').value = p.folioHC || '';
            
            document.querySelectorAll('.edit-cb-red').forEach(cb => {
                cb.checked = p.estudios.includes(cb.value);
            });
            document.getElementById('modal-editar-paciente-red').classList.remove('hidden');
        }

        function guardarEdicionPacienteRed() {
            const id = document.getElementById('edit-id-paciente-red').value;
            const p = bdGlobal[fechaActualStr][sucursalActual].pacientes.find(x => x.id === id);
            if(!p) return;

            p.nombre = document.getElementById('edit-nombre-red').value.trim();
            p.fechaNacimiento = document.getElementById('edit-nacimiento-red').value;
            p.numeroOrden = document.getElementById('edit-orden-red').value.trim();
            p.folioHC = document.getElementById('edit-folio-red').value.trim();

            const cbs = document.querySelectorAll('.edit-cb-red:checked');
            const nuevosEstudios = Array.from(cbs).map(cb => cb.value);
            
            p.estudios.forEach(est => {
                if (!nuevosEstudios.includes(est)) delete p.docsStatus[`doc-${p.id}-${obtenerSufijoEstudio(est)}`];
            });

            nuevosEstudios.forEach(est => {
                const docKey = `doc-${p.id}-${obtenerSufijoEstudio(est)}`;
                if (!p.docsStatus[docKey]) p.docsStatus[docKey] = { estado: 'pendiente', notas: [], vistosAdmin: 0, vistosSucursal: 0, checklist: [] };
            });
            
            p.estudios = nuevosEstudios;

            document.getElementById('modal-editar-paciente-red').classList.add('hidden');
            actualizarUI();

            if (db) db.collection("PacientesRed").doc(p.id).set(p).catch(e => console.error(e));
        }
            
        async function procesarLoteArchivosRed(files) {
            if (!files || files.length === 0) return;
            if (files.length > 5) { mostrarToast("Para evitar saturar el sistema, arrastra m√°ximo 5 archivos a la vez."); return; }

            const overlay = document.getElementById('overlay-carga-lote');
            const textoEstado = document.getElementById('texto-estado-lote');
            if(overlay) overlay.classList.remove('hidden');

            for (let i = 0; i < files.length; i++) {
                if(textoEstado) textoEstado.textContent = `Extrayendo datos y enlazando archivo ${i + 1} de ${files.length}...`;
                console.log(`\n--- PROCESANDO ARCHIVO RED: ${files[i].name} ---`);
                
                try {
                    const base64 = await convertirArchivoABase64(files[i]);
                    const req = await fetch('/.netlify/functions/analizarDocumento', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ pdfBase64: base64, tipoDocumento: 'Extraccion' })
                    });
                    if (!req.ok) throw new Error(`El servidor fall√≥ con c√≥digo ${req.status}.`);
                    const resJSON = JSON.parse(await req.text());
                    asignarDocumentoAPacienteRed(resJSON, base64);
                } catch (e) { 
                    console.error("-> ERROR EN EL PROCESO DE RED:", e);
                    mostrarToast(`Error con el archivo ${files[i].name}:\n${e.message}`);
                }
            }
            if(overlay) overlay.classList.add('hidden');
            document.getElementById('file-upload-lote-red').value = ""; 
            actualizarUI();
        }

        function asignarDocumentoAPacienteRed(datosExtraidos, base64) {
            const tipo = datosExtraidos.tipoDocumento || datosExtraidos.TipoDocumento;
            const nom = datosExtraidos.nombre || datosExtraidos.Nombre;
            const nac = datosExtraidos.fechaNacimiento || datosExtraidos.FechaNacimiento || '';
            let ord = datosExtraidos.orden || datosExtraidos.Orden || '';
            let fol = datosExtraidos.folio || datosExtraidos.Folio || '';

            // FILTRO ESTRICTO DE IDENTIFICADORES (IA)
            if (tipo && tipo.includes('Historia')) {
                ord = ''; // Si es HC, borramos la orden
            } else {
                fol = ''; // Si NO es HC, borramos el folio
            }

            if (!tipo || !nom || nom.trim() === '') {
                mostrarToast("‚ö†Ô∏è La IA no pudo encontrar el Nombre del paciente o el Tipo de Documento. Se omiti√≥.");
                return;
            }

            const sufijoDoc = obtenerSufijoEstudio(tipo);

            // Buscar si ya existe el paciente en esta Sucursal
            let pacienteExistente = bdGlobal[fechaActualStr][sucursalActual].pacientes.find(p => 
                (ord && p.numeroOrden === ord) || (fol && p.folioHC === fol) || (p.nombre && nom && p.nombre.toLowerCase().includes(nom.toLowerCase().split(' ')[0]))
            );

            if (pacienteExistente) {
                if (!pacienteExistente.estudios.includes(tipo)) {
                    pacienteExistente.estudios.push(tipo);
                }
                
                const docKey = `doc-${pacienteExistente.id}-${sufijoDoc}`;
                pacienteExistente.docsStatus[docKey] = { estado: 'subido', pdfBase64: base64, horaSubida: new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }), notas: [], vistosAdmin: 0, vistosSucursal: 0, checklist: [] };
                
                if (!pacienteExistente.fechaNacimiento && nac) pacienteExistente.fechaNacimiento = nac;
                if (!pacienteExistente.numeroOrden && ord) pacienteExistente.numeroOrden = ord;
                if (!pacienteExistente.folioHC && fol) pacienteExistente.folioHC = fol;

                if (db) db.collection("PacientesRed").doc(pacienteExistente.id).set(pacienteExistente);
            } else {
                const nuevoId = Date.now().toString() + Math.floor(Math.random()*100);
                const docKey = `doc-${nuevoId}-${sufijoDoc}`;
                
                let docsDelPaciente = {};
                docsDelPaciente[docKey] = { estado: 'subido', pdfBase64: base64, horaSubida: new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }), notas: [], vistosAdmin: 0, vistosSucursal: 0, checklist: [] };
                
                const nuevoPaciente = { 
                    id: nuevoId, sucursal: sucursalActual, fechaOperativa: fechaActualStr, nombre: nom, 
                    fechaNacimiento: nac, numeroOrden: ord, folioHC: fol,
                    estudios: [tipo], docsStatus: docsDelPaciente, datosExtraidosHC: null
                };

                bdGlobal[fechaActualStr][sucursalActual].pacientes.push(nuevoPaciente);
                if(db) db.collection("PacientesRed").doc(nuevoPaciente.id).set(nuevoPaciente);
            }
        }
    </script>
</body>
</html>
